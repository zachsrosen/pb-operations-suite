<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Photon Brothers Master Scheduler - Crew scheduling, calendar management, and install coordination">
<meta name="theme-color" content="#0a0a0f">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>PB Master Scheduler | Photon Brothers</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #0a0a0f;
  --surface: #12121a;
  --surface-hover: #1a1a24;
  --border: #1e1e2e;
  --text: #e4e4e7;
  --text-dim: #71717a;
  --accent: #f97316;
  --accent-dim: rgba(249, 115, 22, 0.15);
  --rtb: #10b981;
  --rtb-blocked: #eab308;
  --construction: #3b82f6;
  --inspection: #8b5cf6;
  --solar: #06b6d4;
  --battery: #a855f7;
  --conflict: #ef4444;
  --success: #22c55e;
}
body { font-family: 'Space Grotesk', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; overflow: hidden; }

/* Main Layout */
.app { display: grid; grid-template-columns: 360px 1fr 280px; height: 100vh; }
.sidebar { background: var(--surface); border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }
.main { display: flex; flex-direction: column; overflow: hidden; }
.right-panel { background: var(--surface); border-left: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }

/* Header */
header { padding: 1rem; border-bottom: 1px solid var(--border); background: linear-gradient(135deg, var(--surface), #1a1a28); }
.header-row { display: flex; justify-content: space-between; align-items: center; }
h1 { font-size: 1.2rem; font-weight: 700; background: linear-gradient(135deg, var(--accent), #fb923c); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.subtitle { font-size: 0.65rem; color: var(--text-dim); margin-top: 2px; }
.header-actions { display: flex; gap: 6px; }
.header-btn { padding: 6px 10px; font-size: 0.7rem; border-radius: 6px; cursor: pointer; background: var(--bg); border: 1px solid var(--border); color: var(--text); transition: all 0.15s; font-family: inherit; }
.header-btn:hover { border-color: var(--accent); color: var(--accent); }
.header-btn.primary { background: var(--accent); border-color: var(--accent); color: #000; font-weight: 600; }
.header-btn.primary:hover { background: #ea580c; }

/* View Tabs */
.view-tabs { display: flex; gap: 2px; padding: 0.5rem; background: var(--bg); border-bottom: 1px solid var(--border); }
.view-tab { flex: 1; padding: 8px; font-size: 0.7rem; font-weight: 600; border-radius: 6px; cursor: pointer; background: var(--surface); border: 1px solid var(--border); color: var(--text-dim); transition: all 0.15s; text-align: center; }
.view-tab:hover { border-color: var(--text-dim); }
.view-tab.active { border-color: var(--accent); color: var(--accent); background: var(--accent-dim); }

/* Location Tabs */
.location-tabs { display: flex; gap: 2px; padding: 0.5rem; background: var(--bg); border-bottom: 1px solid var(--border); overflow-x: auto; }
.location-tab { padding: 6px 10px; font-size: 0.65rem; font-weight: 500; border-radius: 6px; cursor: pointer; background: var(--surface); border: 1px solid var(--border); color: var(--text-dim); transition: all 0.15s; white-space: nowrap; }
.location-tab:hover { border-color: var(--text-dim); }
.location-tab.active { border-color: var(--accent); color: var(--accent); background: var(--accent-dim); }
.location-tab .count { font-family: 'JetBrains Mono', monospace; margin-left: 4px; opacity: 0.7; }
.location-tab .revenue { font-size: 0.55rem; opacity: 0.6; display: block; }

/* Stats Bar */
.stats-bar { display: flex; gap: 6px; padding: 0.5rem; background: var(--bg); border-bottom: 1px solid var(--border); flex-wrap: wrap; }
.stat { display: flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--surface); border-radius: 6px; border: 1px solid var(--border); }
.stat-dot { width: 8px; height: 8px; border-radius: 2px; }
.stat-value { font-family: 'JetBrains Mono', monospace; font-weight: 600; font-size: 0.8rem; }
.stat-label { font-size: 0.55rem; color: var(--text-dim); text-transform: uppercase; }

/* Queue Sidebar */
.queue-header { padding: 0.75rem; border-bottom: 1px solid var(--border); }
.queue-header h2 { font-size: 0.8rem; font-weight: 600; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 6px; }
.stage-tabs { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 0.5rem; }
.stage-tab { padding: 4px 8px; font-size: 0.6rem; border-radius: 4px; cursor: pointer; background: var(--bg); border: 1px solid var(--border); color: var(--text-dim); transition: all 0.15s; }
.stage-tab:hover { border-color: var(--text-dim); }
.stage-tab.active { border-color: var(--accent); color: var(--accent); background: var(--accent-dim); }
.stage-tab.rtb.active { border-color: var(--rtb); color: var(--rtb); background: rgba(16, 185, 129, 0.1); }
.stage-tab.blocked.active { border-color: var(--rtb-blocked); color: var(--rtb-blocked); background: rgba(234, 179, 8, 0.1); }
.stage-tab.construction.active { border-color: var(--construction); color: var(--construction); background: rgba(59, 130, 246, 0.1); }

.queue-filters { display: flex; flex-direction: column; gap: 4px; }
.queue-filters input, .queue-filters select { width: 100%; background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 6px 8px; border-radius: 6px; font-family: inherit; font-size: 0.7rem; }
.queue-filters input:focus, .queue-filters select:focus { outline: none; border-color: var(--accent); }
.queue-count { font-size: 0.65rem; color: var(--text-dim); padding: 0.5rem 0.75rem; border-bottom: 1px solid var(--border); background: var(--bg); display: flex; justify-content: space-between; }
.queue-list { flex: 1; overflow-y: auto; padding: 0.5rem; }

/* Queue Items - Draggable */
.queue-item { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 0.6rem; margin-bottom: 0.4rem; cursor: grab; transition: all 0.15s; position: relative; }
.queue-item:hover { border-color: var(--accent); transform: translateX(2px); }
.queue-item.selected { border-color: var(--accent); background: var(--accent-dim); box-shadow: 0 0 0 1px var(--accent); }
.queue-item.dragging { opacity: 0.5; cursor: grabbing; }
.queue-item.rtb { border-left: 3px solid var(--rtb); }
.queue-item.blocked { border-left: 3px solid var(--rtb-blocked); }
.queue-item.construction { border-left: 3px solid var(--construction); }
.queue-item-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2px; }
.queue-item-name { font-size: 0.7rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px; }
.queue-item-amount { font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; color: var(--accent); font-weight: 600; }
.queue-item-address { font-size: 0.6rem; color: var(--text-dim); margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.queue-item-meta { display: flex; gap: 4px; flex-wrap: wrap; align-items: center; }
.queue-item-tag { font-size: 0.5rem; padding: 2px 4px; border-radius: 3px; background: var(--border); color: var(--text-dim); }
.queue-item-tag.solar { background: rgba(6, 182, 212, 0.2); color: var(--solar); }
.queue-item-tag.battery { background: rgba(168, 85, 247, 0.2); color: var(--battery); }
.queue-item-tag.rtb { background: rgba(16, 185, 129, 0.2); color: var(--rtb); }
.queue-item-tag.blocked { background: rgba(234, 179, 8, 0.2); color: var(--rtb-blocked); }
.queue-item-tag.construction { background: rgba(59, 130, 246, 0.2); color: var(--construction); }
.queue-item-tag.scheduled { background: rgba(59, 130, 246, 0.3); color: var(--construction); font-weight: 600; }
.queue-item-specs { display: flex; gap: 6px; margin-top: 4px; flex-wrap: wrap; }
.spec { font-size: 0.55rem; color: var(--text-dim); }
.spec strong { color: var(--text); }

/* Calendar Container */
.calendar-container { flex: 1; padding: 0.75rem; overflow-y: auto; }
.month-nav { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem; padding: 0 0.5rem; }
.month-nav button { background: var(--surface); border: 1px solid var(--border); color: var(--text); padding: 6px 12px; border-radius: 6px; cursor: pointer; font-family: inherit; font-size: 0.7rem; transition: all 0.15s; }
.month-nav button:hover { background: var(--border); }
.month-title { font-size: 1rem; font-weight: 600; }
.today-btn { font-size: 0.65rem; padding: 4px 8px; }

/* Calendar Grid */
.calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; background: var(--border); border-radius: 8px; overflow: hidden; padding: 2px; }
.day-header { background: var(--surface); padding: 8px 4px; text-align: center; font-weight: 600; font-size: 0.65rem; color: var(--text-dim); }
.day { background: var(--surface); min-height: 90px; padding: 4px; position: relative; cursor: pointer; transition: all 0.15s; }
.day:hover { background: var(--surface-hover); }
.day.other-month { opacity: 0.4; }
.day.today { box-shadow: inset 0 0 0 2px var(--accent); }
.day.drop-target { background: var(--accent-dim); box-shadow: inset 0 0 0 2px var(--accent); }
.day.weekend { background: rgba(0,0,0,0.2); }
.day-number { font-size: 0.7rem; font-weight: 600; margin-bottom: 2px; color: var(--text-dim); }
.day.today .day-number { color: var(--accent); }

/* Calendar Events */
.event { font-size: 0.55rem; padding: 3px 4px; border-radius: 3px; margin-bottom: 2px; cursor: pointer; transition: all 0.1s; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.event:hover { transform: scale(1.02); box-shadow: 0 4px 12px rgba(0,0,0,0.4); z-index: 10; position: relative; }
.event.rtb { background: var(--rtb); color: #000; }
.event.blocked { background: var(--rtb-blocked); color: #000; }
.event.construction { background: var(--construction); color: #fff; }
.event.scheduled { background: var(--solar); color: #fff; }
.event.conflict { background: var(--conflict); color: #fff; animation: pulse 1s infinite; }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
.event .day-num { font-size: 0.5rem; opacity: 0.8; }
.more-events { font-size: 0.55rem; color: var(--text-dim); text-align: center; padding: 2px; cursor: pointer; }

/* Week View */
.week-view { display: none; }
.week-view.active { display: block; }
.calendar-view { display: block; }
.calendar-view.hidden { display: none; }

.week-nav { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding: 0 8px; }
.week-nav button { background: var(--surface); border: 1px solid var(--border); color: var(--text); padding: 6px 12px; border-radius: 6px; cursor: pointer; font-family: inherit; font-size: 0.7rem; transition: all 0.15s; }
.week-nav button:hover { background: var(--border); }
.week-title { font-size: 0.9rem; font-weight: 600; }

.week-grid { display: grid; grid-template-columns: 100px repeat(5, 1fr); gap: 1px; background: var(--border); border-radius: 8px; overflow: hidden; }
.week-header { background: var(--surface); padding: 10px 8px; text-align: center; font-size: 0.7rem; font-weight: 600; color: var(--text-dim); }
.week-header.today { color: var(--accent); background: var(--accent-dim); }
.week-header .date-num { font-size: 1rem; font-weight: 700; display: block; margin-top: 2px; color: var(--text); }
.crew-row-header { background: var(--bg); padding: 10px 8px; font-size: 0.7rem; font-weight: 600; display: flex; flex-direction: column; gap: 4px; border-right: 3px solid var(--accent); }
.crew-row-header .crew-name { color: var(--text); }
.crew-row-header .crew-stats { font-size: 0.55rem; color: var(--text-dim); font-weight: 400; }
.week-cell { background: var(--surface); min-height: 70px; padding: 4px; position: relative; cursor: pointer; transition: background 0.15s; }
.week-cell:hover { background: var(--surface-hover); }
.week-cell.drop-target { background: var(--accent-dim); box-shadow: inset 0 0 0 2px var(--accent); }
.week-cell .event { font-size: 0.6rem; padding: 4px 6px; margin-bottom: 3px; }

/* Gantt View */
.gantt-container { padding: 0 8px; }
.gantt-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
.gantt-title { font-size: 0.9rem; font-weight: 600; }
.gantt-legend { display: flex; gap: 12px; font-size: 0.6rem; }
.gantt-legend-item { display: flex; align-items: center; gap: 4px; }
.gantt-legend-box { width: 12px; height: 12px; border-radius: 3px; }
.gantt-grid { background: var(--border); border-radius: 8px; overflow: hidden; }
.gantt-timeline { display: grid; grid-template-columns: 140px repeat(14, 1fr); gap: 1px; }
.gantt-day-header { background: var(--surface); padding: 6px 4px; text-align: center; font-size: 0.55rem; color: var(--text-dim); }
.gantt-day-header.today { background: var(--accent-dim); color: var(--accent); }
.gantt-day-header .day-name { font-weight: 600; }
.gantt-day-header .day-num { font-size: 0.7rem; color: var(--text); display: block; }
.gantt-crew-header { background: var(--bg); padding: 8px; font-size: 0.7rem; font-weight: 600; }
.gantt-row { display: grid; grid-template-columns: 140px repeat(14, 1fr); gap: 1px; min-height: 50px; }
.gantt-cell { background: var(--surface); position: relative; }
.gantt-bar { position: absolute; top: 8px; bottom: 8px; border-radius: 4px; display: flex; align-items: center; padding: 0 6px; font-size: 0.55rem; font-weight: 500; color: #fff; cursor: pointer; transition: all 0.15s; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; z-index: 1; }
.gantt-bar:hover { transform: scaleY(1.1); box-shadow: 0 4px 12px rgba(0,0,0,0.4); z-index: 2; }
.gantt-bar.construction { background: var(--construction); }
.gantt-bar.rtb { background: var(--rtb); }
.gantt-bar.scheduled { background: var(--solar); }
.gantt-bar.blocked { background: var(--rtb-blocked); color: #000; }

/* Right Panel - Crew & Conflicts */
.panel-section { padding: 0.75rem; border-bottom: 1px solid var(--border); }
.panel-title { font-size: 0.75rem; font-weight: 600; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 6px; }
.crew-card { background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 8px; margin-bottom: 6px; }
.crew-name { font-size: 0.7rem; font-weight: 600; margin-bottom: 4px; }
.crew-capacity { display: flex; gap: 8px; margin-bottom: 6px; }
.capacity-item { font-size: 0.6rem; display: flex; align-items: center; gap: 4px; }
.capacity-bar { height: 4px; background: var(--border); border-radius: 2px; flex: 1; overflow: hidden; }
.capacity-fill { height: 100%; background: var(--rtb); transition: width 0.3s; }
.capacity-fill.warning { background: var(--rtb-blocked); }
.capacity-fill.full { background: var(--conflict); }
.crew-utilization { font-size: 0.6rem; color: var(--text-dim); }

/* Conflict List */
.conflict-item { background: rgba(239, 68, 68, 0.1); border: 1px solid var(--conflict); border-radius: 6px; padding: 8px; margin-bottom: 6px; font-size: 0.65rem; }
.conflict-title { font-weight: 600; color: var(--conflict); margin-bottom: 4px; }
.conflict-detail { color: var(--text-dim); }

/* Optimization Panel */
.optimize-btn { width: 100%; padding: 10px; font-size: 0.75rem; border-radius: 6px; cursor: pointer; background: linear-gradient(135deg, var(--accent), #fb923c); border: none; color: #000; font-weight: 600; font-family: inherit; transition: all 0.15s; }
.optimize-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3); }
.optimize-stats { margin-top: 8px; font-size: 0.6rem; color: var(--text-dim); }

/* Export Panel */
.export-btns { display: flex; flex-direction: column; gap: 6px; }
.export-btn { padding: 8px; font-size: 0.7rem; border-radius: 6px; cursor: pointer; background: var(--bg); border: 1px solid var(--border); color: var(--text); font-family: inherit; transition: all 0.15s; text-align: left; }
.export-btn:hover { border-color: var(--accent); }

/* Modal */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 1000; }
.modal-overlay.visible { display: flex; }
.modal { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem; max-width: 500px; width: 90%; max-height: 85vh; overflow-y: auto; }
.modal h3 { font-size: 1rem; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 8px; }
.modal-body { margin-bottom: 1rem; }
.modal-section { margin-bottom: 0.75rem; }
.modal-section-title { font-size: 0.65rem; color: var(--text-dim); text-transform: uppercase; margin-bottom: 4px; font-weight: 600; }
.modal-row { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid var(--border); font-size: 0.75rem; }
.modal-row:last-child { border-bottom: none; }
.modal-label { color: var(--text-dim); }
.modal-actions { display: flex; gap: 8px; justify-content: flex-end; flex-wrap: wrap; }
.modal-btn { padding: 8px 14px; border-radius: 6px; font-family: inherit; font-size: 0.75rem; cursor: pointer; transition: all 0.15s; }
.modal-btn.cancel { background: var(--bg); border: 1px solid var(--border); color: var(--text); }
.modal-btn.cancel:hover { background: var(--border); }
.modal-btn.confirm { background: var(--accent); border: 1px solid var(--accent); color: #000; font-weight: 600; }
.modal-btn.confirm:hover { background: #ea580c; }
.modal-btn.hubspot { background: #ff7a59; border: 1px solid #ff7a59; color: #fff; font-weight: 600; text-decoration: none; }

/* Form Inputs */
.form-row { display: flex; gap: 10px; margin-top: 8px; flex-wrap: wrap; align-items: center; }
.form-row label { font-size: 0.7rem; color: var(--text-dim); }
.form-row input, .form-row select { background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 6px 8px; border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; }
.form-row input[type="number"] { width: 60px; text-align: center; }

/* Toast */
.toast { position: fixed; bottom: 1.5rem; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--success); color: #000; padding: 10px 20px; border-radius: 8px; font-size: 0.8rem; font-weight: 500; opacity: 0; transition: all 0.3s; z-index: 1001; }
.toast.visible { transform: translateX(-50%) translateY(0); opacity: 1; }
.toast.error { background: var(--conflict); color: #fff; }

/* Scrollbar */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }

/* Responsive */
@media (max-width: 1400px) { .app { grid-template-columns: 320px 1fr 240px; } }
@media (max-width: 1100px) { .right-panel { display: none; } .app { grid-template-columns: 320px 1fr; } }
@media (max-width: 900px) { .app { grid-template-columns: 1fr; } .sidebar { max-height: 40vh; } }
</style>
</head>
<body>

<div class="app">
  <!-- Left Sidebar - Pipeline Queue -->
  <aside class="sidebar">
    <header>
      <div class="header-row">
        <div>
          <h1>‚ö° PB Master Scheduler</h1>
          <div class="subtitle">RTB + Construction ‚Ä¢ Live HubSpot Data</div>
        </div>
        <div class="header-actions">
          <button class="header-btn" onclick="exportCSV()">üì• CSV</button>
        </div>
      </div>
    </header>

    <div class="queue-header">
      <h2>üìã Install Pipeline</h2>
      <div class="stage-tabs" id="stageTabs"></div>
      <div class="queue-filters">
        <input type="text" id="searchInput" placeholder="üîç Search projects...">
        <select id="typeFilter">
          <option value="">All Types</option>
          <option value="Solar">‚òÄÔ∏è Solar</option>
          <option value="Battery">üîã Battery</option>
          <option value="EV">üîå EV Charger</option>
        </select>
        <select id="sortFilter">
          <option value="amount">Sort: Revenue ‚Üì</option>
          <option value="date">Sort: Date</option>
          <option value="days">Sort: Install Days</option>
        </select>
      </div>
    </div>

    <div class="queue-count" id="queueCount">
      <span>0 projects</span>
      <span>$0K</span>
    </div>
    <div class="queue-list" id="queueList"></div>
  </aside>

  <!-- Main: Calendar/Week Views -->
  <main class="main">
    <div class="view-tabs">
      <div class="view-tab active" data-view="calendar" onclick="switchView('calendar')">üìÖ Month</div>
      <div class="view-tab" data-view="week" onclick="switchView('week')">üìä Week</div>
      <div class="view-tab" data-view="gantt" onclick="switchView('gantt')">üìà Gantt</div>
    </div>

    <div class="location-tabs" id="locationTabs"></div>
    <div class="stats-bar" id="statsBar"></div>

    <div class="calendar-container">
      <div class="instructions" id="instructions" style="display:none; background: var(--accent-dim); border: 1px solid var(--accent); border-radius: 8px; padding: 8px 12px; margin-bottom: 8px;">
        <span style="font-size: 0.75rem; color: var(--accent);">üìÖ <strong id="selectedProjectName">Project</strong> selected ‚Äî click a day to schedule or drag to calendar</span>
      </div>

      <div class="month-nav">
        <button onclick="prevMonth()">‚Üê Prev</button>
        <div class="month-title" id="monthTitle">January 2026</div>
        <button onclick="nextMonth()">Next ‚Üí</button>
        <button class="today-btn" onclick="goToToday()">Today</button>
      </div>

      <!-- Calendar View -->
      <div class="calendar-view" id="calendarView">
        <div class="calendar" id="calendar"></div>
      </div>

      <!-- Week View -->
      <div class="week-view" id="weekView">
        <div class="week-nav">
          <button onclick="prevWeek()">‚Üê Prev Week</button>
          <div class="week-title" id="weekTitle">Week of Jan 13, 2026</div>
          <button onclick="nextWeek()">Next Week ‚Üí</button>
        </div>
        <div class="week-grid" id="weekGrid"></div>
      </div>

      <!-- Gantt View -->
      <div class="week-view" id="ganttView">
        <div class="gantt-container">
          <div class="gantt-header">
            <div class="gantt-title" id="ganttTitle">üìà 2-Week Project Timeline</div>
            <div class="gantt-legend">
              <div class="gantt-legend-item"><div class="gantt-legend-box" style="background: var(--construction);"></div> In Construction</div>
              <div class="gantt-legend-item"><div class="gantt-legend-box" style="background: var(--solar);"></div> Scheduled</div>
              <div class="gantt-legend-item"><div class="gantt-legend-box" style="background: var(--rtb);"></div> RTB</div>
            </div>
          </div>
          <div class="gantt-grid" id="ganttGrid"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Right Panel - Crew & Optimization -->
  <aside class="right-panel">
    <div class="panel-section">
      <div class="panel-title">ü§ñ Auto-Optimize</div>
      <button class="optimize-btn" onclick="autoOptimize()">‚ö° Optimize Schedule</button>
      <div class="optimize-stats" id="optimizeStats">
        Click to auto-schedule RTB projects by revenue priority
      </div>
    </div>

    <div class="panel-section">
      <div class="panel-title">üë∑ Crew Capacity</div>
      <div id="crewCapacity"></div>
    </div>

    <div class="panel-section">
      <div class="panel-title">‚ö†Ô∏è Conflicts (<span id="conflictCount">0</span>)</div>
      <div id="conflictList">
        <div style="font-size: 0.65rem; color: var(--text-dim);">No scheduling conflicts</div>
      </div>
    </div>

    <div class="panel-section">
      <div class="panel-title">üì§ Export</div>
      <div class="export-btns">
        <button class="export-btn" onclick="exportCSV()">üì• Download CSV</button>
        <button class="export-btn" onclick="exportICal()">üìÖ Export iCal</button>
        <button class="export-btn" onclick="copySchedule()">üìã Copy to Clipboard</button>
      </div>
    </div>

    <div class="panel-section" style="border-bottom: none;">
      <div class="panel-title">‚å®Ô∏è Keyboard Shortcuts</div>
      <div style="font-size: 0.6rem; color: var(--text-dim); line-height: 1.6;">
        <div><kbd style="background: var(--bg); padding: 2px 4px; border-radius: 3px; font-family: 'JetBrains Mono', monospace;">1</kbd> <kbd>2</kbd> <kbd>3</kbd> Switch views</div>
        <div><kbd style="background: var(--bg); padding: 2px 4px; border-radius: 3px; font-family: 'JetBrains Mono', monospace;">Alt+‚Üê/‚Üí</kbd> Navigate</div>
        <div><kbd style="background: var(--bg); padding: 2px 4px; border-radius: 3px; font-family: 'JetBrains Mono', monospace;">Ctrl+O</kbd> Auto-optimize</div>
        <div><kbd style="background: var(--bg); padding: 2px 4px; border-radius: 3px; font-family: 'JetBrains Mono', monospace;">Ctrl+E</kbd> Export CSV</div>
        <div><kbd style="background: var(--bg); padding: 2px 4px; border-radius: 3px; font-family: 'JetBrains Mono', monospace;">Esc</kbd> Close / Deselect</div>
      </div>
    </div>
  </aside>
</div>

<!-- Schedule Modal -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <h3>üìÖ Schedule Install</h3>
    <div class="modal-body" id="modalBody"></div>
    <div class="modal-actions">
      <button class="modal-btn cancel" onclick="closeModal()">Cancel</button>
      <button class="modal-btn confirm" onclick="confirmSchedule()">Schedule</button>
    </div>
  </div>
</div>

<!-- Detail Modal -->
<div class="modal-overlay" id="detailModal">
  <div class="modal">
    <h3>üìã Project Details</h3>
    <div class="modal-body" id="detailModalBody"></div>
    <div class="modal-actions">
      <a class="modal-btn hubspot" id="hubspotLink" href="#" target="_blank">Open in HubSpot ‚Üó</a>
      <button class="modal-btn cancel" onclick="closeDetailModal()">Close</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ============================================================
// PHOTON BROTHERS MASTER SCHEDULER v3
// Merged & Optimized from pb-scheduler-enhanced + pb-install-scheduler-v2
// ============================================================

// ===== PROJECT DATA (from HubSpot) =====
const projects = [
  // CONSTRUCTION (already scheduled)
  { id: "32743168407", name: "PROJ-7634 | American Water Works", address: "6666 W Quincy Ave, Denver, CO", location: "Centennial", amount: 299500, type: "Solar", stage: "construction", systemSize: 114.81, batteries: 0, batteryModel: null, crew: "DTC Alpha", daysInstall: 5, daysElec: 3, roofType: "Membrane EPDM", scheduleDate: "2025-10-27", hubspotUrl: "https://app.hubspot.com/contacts/21710069/record/0-3/32743168407" },
  { id: "13126218378", name: "PROJ-6839 | Whittier Place", address: "2301 Pearl St, Boulder, CO", location: "Westminster", amount: 87249, type: "Solar", stage: "construction", systemSize: 29.1, batteries: 0, batteryModel: null, crew: "WESTY Bravo", daysInstall: 3, daysElec: 2, roofType: "Composition", scheduleDate: "2026-01-05", hubspotUrl: "https://app.hubspot.com/contacts/21710069/record/0-3/13126218378" },
  { id: "18872830551", name: "PROJ-7075 | Miller J", address: "2315 S Monroe St, Denver, CO", location: "Centennial", amount: 72563, type: "Battery;Solar", stage: "construction", systemSize: 13.2, batteries: 2, batteryModel: "PW3", crew: "DTC Alpha", daysInstall: 3, daysElec: 2, roofType: "Membrane", scheduleDate: "2026-01-14", hubspotUrl: "https://app.hubspot.com/contacts/21710069/record/0-3/18872830551" },
  { id: "42073940556", name: "PROJ-8518 | Neal", address: "9111 E Lost Hill Trl, Lone Tree, CO", location: "Centennial", amount: 52247, type: "Battery;Solar", stage: "construction", systemSize: 10.12, batteries: 1, batteryModel: "PW3", crew: "DTC Alpha", daysInstall: 2, daysElec: 2, roofType: null, scheduleDate: "2026-01-20", hubspotUrl: "https://app.hubspot.com/contacts/21710069/record/0-3/42073940556" },
  { id: "41084998526", name: "PROJ-8367 | Mitchell J", address: "7794 Dyer Rd, Louisville, CO", location: "Westminster", amount: 38424, type: "Battery;Solar", stage: "construction", systemSize: 8.17, batteries: 1, batteryModel: "PW3", crew: "WESTY Alpha", daysInstall: 2, daysElec: 1, roofType: null, scheduleDate: "2026-01-16", hubspotUrl: "https://app.hubspot.com/contacts/21710069/record/0-3/41084998526" },
  { id: "43170798722", name: "PROJ-8594 | SAGE", address: "4975 Dover Dr, Colorado Springs, CO", location: "Colorado Springs", amount: 35951, type: "Battery;Solar", stage: "construction", systemSize: 7.31, batteries: 1, batteryModel: "PW3", crew: "COSP Alpha", daysInstall: 2, daysElec: 1, roofType: "Composition", scheduleDate: "2026-01-07", hubspotUrl: "https://app.hubspot.com/contacts/21710069/record/0-3/43170798722" },
  { id: "48425963637", name: "PROJ-8812 | Ammon", address: "1722 Bee Canyon Rd, Arroyo Grande, CA", location: "San Luis Obispo", amount: 32124, type: "Battery", stage: "construction", systemSize: null, batteries: 1, batteryModel: "PW3", crew: "SLO Electrical 1", daysInstall: 1, daysElec: 1, roofType: null, scheduleDate: "2026-01-15", hubspotUrl: "https://app.hubspot.com/contacts/21710069/record/0-3/48425963637" },
  { id: "43216836975", name: "PROJ-8654 | Lingle", address: "13825 Overlook Pl, Colorado Springs, CO", location: "Colorado Springs", amount: 28728, type: "Battery", stage: "construction", systemSize: 0, batteries: 1, batteryModel: "PW3", crew: "COSP Alpha", daysInstall: 1, daysElec: 2, roofType: "Composition", scheduleDate: "2026-01-05", hubspotUrl: "https://app.hubspot.com/contacts/21710069/record/0-3/43216836975" },

  // WESTMINSTER - RTB
  { id: "39049084790", name: "PROJ-8128 | Martin", address: "2940 18th St, Boulder, CO", location: "Westminster", amount: 49460, type: "Battery;Solar", stage: "rtb", systemSize: 8.6, batteries: 1, batteryModel: "PW3", crew: "WESTY Alpha", daysInstall: 2, daysElec: 1, roofType: null, scheduleDate: null, hubspotUrl: "https://app.hubspot.com/contacts/21710069/record/0-3/39049084790" },
  { id: "42568336245", name: "PROJ-8489 | Hidalgo", address: "6689 Blazing Star Ct, Boulder, CO", location: "Westminster", amount: 39464, type: "Solar", stage: "rtb", systemSize: 13.86, batteries: 0, batteryModel: null, crew: "WESTY Bravo", daysInstall: 2, daysElec: 1, roofType: "Composition", scheduleDate: null, hubspotUrl: "https://app.hubspot.com/contacts/21710069/record/0-3/42568336245" },
  { id: "41696679728", name: "PROJ-8500 | Berman", address: "699 Quince Circle, Boulder, CO", location: "Westminster", amount: 37417, type: "Battery;Solar", stage: "rtb", systemSize: 9.24, batteries: 1, batteryModel: "PW3", crew: "WESTY Bravo", daysInstall: 2, daysElec: 1, roofType: "Composition", scheduleDate: null, hubspotUrl: "https://app.hubspot.com/contacts/21710069/record/0-3/41696679728" },
  { id: "20307498596", name: "PROJ-8182 | Hancz", address: "213 Deer Trail Cir, Boulder, CO", location: "Westminster", amount: 37388, type: "Battery;Solar", stage: "rtb", systemSize: 5.59, batteries: 1, batteryModel: "PW3", crew: "WESTY Alpha", daysInstall: 2, daysElec: 1, roofType: "Composition", scheduleDate: null, hubspotUrl: "https://app.hubspot.com/contacts/21710069/record/0-3/20307498596" },
  { id: "46825526853", name: "PROJ-8771 | Rassokhin", address: "8470 W 74th Dr, Arvada, CO", location: "Westminster", amount: 34258, type: "Solar", stage: "rtb", systemSize: 10.56, batteries: 0, batteryModel: null, crew: "WESTY Alpha", daysInstall: 2, daysElec: 2, roofType: "Composition", scheduleDate: null, hubspotUrl: "https://app.hubspot.com/contacts/21710069/record/0-3/46825526853" },
  { id: "22337108294", name: "PROJ-8006 | Yan Zhang", address: "7 Benchmark Dr, Boulder, CO", location: "Westminster", amount: 32007, type: "Battery;Solar", stage: "rtb", systemSize: 6.88, batteries: 1, batteryModel: "PW3", crew: "WESTY Alpha", daysInstall: 2, daysElec: 1, roofType: "Composition", scheduleDate: null, hubspotUrl: "https://app.hubspot.com/contacts/21710069/record/0-3/22337108294" },

  // WESTMINSTER - BLOCKED
  { id: "23303209770", name: "PROJ-8048 | Huynh", address: "12649 Appaloosa Pl, Broomfield, CO", location: "Westminster", amount: 70000, type: "Solar;Battery", stage: "blocked", systemSize: 19.78, batteries: 1, batteryModel: "PW3", crew: "WESTY Alpha", daysInstall: 2, daysElec: 1, roofType: null, scheduleDate: null, hubspotUrl: "https://app.hubspot.com/contacts/21710069/record/0-3/23303209770" },
  { id: "43125493794", name: "PROJ-8642 | Hart", address: "1234 Doris Cir, Erie, CO", location: "Westminster", amount: 63793, type: "Battery;Solar", stage: "blocked", systemSize: 14.19, batteries: 1, batteryModel: "PW3", crew: "WESTY Alpha", daysInstall: 3, daysElec: 2, roofType: "Metal", scheduleDate: null, hubspotUrl: "https://app.hubspot.com/contacts/21710069/record/0-3/43125493794" },
  { id: "43483187506", name: "PROJ-8702 | Schaub", address: "13942 Crestone Cir, Broomfield, CO", location: "Westminster", amount: 55292, type: "Battery;Solar", stage: "blocked", systemSize: 10.75, batteries: 1, batteryModel: "PW3", crew: "WESTY Alpha", daysInstall: 2, daysElec: 1, roofType: "Composition", scheduleDate: null, hubspotUrl: "https://app.hubspot.com/contacts/21710069/record/0-3/43483187506" },
  { id: "41572636232", name: "PROJ-8554 | Strossner", address: "128 Rock Bridge Ct, Windsor, CO", location: "Westminster", amount: 50349, type: "Battery;Solar", stage: "blocked", systemSize: 13.2, batteries: 1, batteryModel: "PW3", crew: "WESTY Bravo", daysInstall: 2, daysElec: 1, roofType: "Composition", scheduleDate: null, hubspotUrl: "https://app.hubspot.com/contacts/21710069/record/0-3/41572636232" },

  // CENTENNIAL - RTB & BLOCKED
  { id: "16317765258", name: "PROJ-7035 | Arrow HQ", address: "9151 E Panorama Cir, Englewood, CO", location: "Centennial", amount: 887389, type: "Solar", stage: "blocked", systemSize: 221.1, batteries: 0, batteryModel: null, crew: null, daysInstall: 10, daysElec: 5, roofType: "Membrane", scheduleDate: null, hubspotUrl: "https://app.hubspot.com/contacts/21710069/record/0-3/16317765258" },
  { id: "43487863931", name: "PROJ-8650 | Rosell", address: "933 Xenon Ct, Golden, CO", location: "Centennial", amount: 56203, type: "Battery;Solar", stage: "blocked", systemSize: 15.4, batteries: 1, batteryModel: "PW3", crew: "DTC Bravo", daysInstall: 2, daysElec: 1, roofType: "Composition", scheduleDate: null, hubspotUrl: "https://app.hubspot.com/contacts/21710069/record/0-3/43487863931" },
  { id: "34099222868", name: "PROJ-7760 | Morris", address: "3518 N Marion St, Denver, CO", location: "Centennial", amount: 42199, type: "Battery;Solar", stage: "blocked", systemSize: 10.32, batteries: 1, batteryModel: "PW3", crew: "DTC Bravo", daysInstall: 2, daysElec: 1, roofType: "Composition", scheduleDate: null, hubspotUrl: "https://app.hubspot.com/contacts/21710069/record/0-3/34099222868" },

  // COLORADO SPRINGS
  { id: "42242445906", name: "PROJ-8524 | Binkowski", address: "15905 Cala Rojo Dr, Colorado Springs, CO", location: "Colorado Springs", amount: 52252, type: "Battery;Solar", stage: "blocked", systemSize: 9.89, batteries: 1, batteryModel: "PW3", crew: "COSP Alpha", daysInstall: 2, daysElec: 2, roofType: "Composition", scheduleDate: null, hubspotUrl: "https://app.hubspot.com/contacts/21710069/record/0-3/42242445906" },
  { id: "46046855252", name: "PROJ-8794 | Selig", address: "1405 Laurette Dr, Colorado Springs, CO", location: "Colorado Springs", amount: 39175, type: "Battery;Solar", stage: "blocked", systemSize: 9.24, batteries: 1, batteryModel: "PW3", crew: "COSP Alpha", daysInstall: 2, daysElec: 2, roofType: "Composition", scheduleDate: null, hubspotUrl: "https://app.hubspot.com/contacts/21710069/record/0-3/46046855252" },

  // SAN LUIS OBISPO - RTB
  { id: "42265220259", name: "PROJ-8540 | Norholm", address: "301 Fair Oaks Ave, Arroyo Grande, CA", location: "San Luis Obispo", amount: 42772, type: "Battery;Solar", stage: "rtb", systemSize: 9, batteries: 1, batteryModel: "PW3", crew: "SLO Electrical 1", daysInstall: 2, daysElec: 1, roofType: "Composition", scheduleDate: null, hubspotUrl: "https://app.hubspot.com/contacts/21710069/record/0-3/42265220259" },
  { id: "41434163825", name: "PROJ-8596 | Eckert", address: "3680 Oakdale Rd, Paso Robles, CA", location: "San Luis Obispo", amount: 36274, type: "Battery", stage: "rtb", systemSize: 0, batteries: 1, batteryModel: "PW3", crew: "SLO Electrical 1", daysInstall: 1, daysElec: 1, roofType: "Composition", scheduleDate: null, hubspotUrl: "https://app.hubspot.com/contacts/21710069/record/0-3/41434163825" },
  { id: "28860087969", name: "PROJ-7370 | Pelisek", address: "1620 Geneseo Rd, Paso Robles, CA", location: "San Luis Obispo", amount: 32950, type: "Battery", stage: "rtb", systemSize: null, batteries: 1, batteryModel: "PW3", crew: "SLO Electrical 2", daysInstall: 1, daysElec: 1, roofType: null, scheduleDate: null, hubspotUrl: "https://app.hubspot.com/contacts/21710069/record/0-3/28860087969" },
  { id: "19495669155", name: "PROJ-7945 | Sahagun", address: "4435 Holly St, Guadalupe, CA", location: "San Luis Obispo", amount: 28400, type: "Battery;Solar", stage: "rtb", systemSize: null, batteries: 1, batteryModel: "PW3", crew: "SLO Solar", daysInstall: 2, daysElec: 1, roofType: "Composition", scheduleDate: null, hubspotUrl: "https://app.hubspot.com/contacts/21710069/record/0-3/19495669155" },

  // CAMARILLO - RTB
  { id: "38866623353", name: "PROJ-8091 | Rakoski", address: "20120 Wells Dr, Woodland Hills, CA", location: "Camarillo", amount: 63745, type: "Solar;Battery", stage: "rtb", systemSize: null, batteries: 1, batteryModel: "PW3", crew: "CAM Crew", daysInstall: 2, daysElec: 1, roofType: "Composition", scheduleDate: null, hubspotUrl: "https://app.hubspot.com/contacts/21710069/record/0-3/38866623353" },
  { id: "43817717324", name: "PROJ-8683 | Richards", address: "645 Skyline Rd, Ventura, CA", location: "Camarillo", amount: 55768, type: "Battery;Solar", stage: "rtb", systemSize: null, batteries: 1, batteryModel: "PW3", crew: "CAM Crew", daysInstall: 2, daysElec: 1, roofType: "Flat", scheduleDate: null, hubspotUrl: "https://app.hubspot.com/contacts/21710069/record/0-3/43817717324" },
  { id: "45369375558", name: "PROJ-8730 | Diep", address: "2277 El Nido Ct, Camarillo, CA", location: "Camarillo", amount: 42966, type: "Battery;Solar", stage: "rtb", systemSize: null, batteries: 2, batteryModel: "PW3", crew: "CAM Crew", daysInstall: 2, daysElec: 1, roofType: "Tile", scheduleDate: null, hubspotUrl: "https://app.hubspot.com/contacts/21710069/record/0-3/45369375558" },
  { id: "42755755408", name: "PROJ-8609 | Case", address: "367 Nueve Ct, Camarillo, CA", location: "Camarillo", amount: 29944, type: "Battery;Solar", stage: "rtb", systemSize: null, batteries: 1, batteryModel: "PW3", crew: "CAM Crew", daysInstall: 2, daysElec: 1, roofType: "Composition", scheduleDate: null, hubspotUrl: "https://app.hubspot.com/contacts/21710069/record/0-3/42755755408" },
  { id: "45934137926", name: "PROJ-8749 | Casselman", address: "27002 Malibu Cove Colony Dr, Malibu, CA", location: "Camarillo", amount: 29431, type: "Battery", stage: "rtb", systemSize: null, batteries: 2, batteryModel: "PW3", crew: "CAM Crew", daysInstall: 1, daysElec: 2, roofType: "Composition", scheduleDate: null, hubspotUrl: "https://app.hubspot.com/contacts/21710069/record/0-3/45934137926" },
  { id: "43946261506", name: "PROJ-8697 | Castillo", address: "1878 Hobart Dr, Camarillo, CA", location: "Camarillo", amount: 18204, type: "Battery", stage: "rtb", systemSize: null, batteries: 1, batteryModel: "PW3", crew: "CAM Crew", daysInstall: 1, daysElec: 1, roofType: null, scheduleDate: null, hubspotUrl: "https://app.hubspot.com/contacts/21710069/record/0-3/43946261506" },
];

// ===== CREW CONFIGURATION =====
const crews = {
  "Westminster": [
    { name: "WESTY Alpha", roofers: 2, electricians: 1, color: "#3b82f6" },
    { name: "WESTY Bravo", roofers: 2, electricians: 1, color: "#10b981" }
  ],
  "Centennial": [
    { name: "DTC Alpha", roofers: 2, electricians: 1, color: "#8b5cf6" },
    { name: "DTC Bravo", roofers: 2, electricians: 1, color: "#ec4899" }
  ],
  "Colorado Springs": [
    { name: "COSP Alpha", roofers: 3, electricians: 1, color: "#f97316" }
  ],
  "San Luis Obispo": [
    { name: "SLO Solar", roofers: 2, electricians: 1, color: "#06b6d4" },
    { name: "SLO Electrical 1", roofers: 0, electricians: 2, color: "#a855f7" },
    { name: "SLO Electrical 2", roofers: 0, electricians: 2, color: "#14b8a6" }
  ],
  "Camarillo": [
    { name: "CAM Crew", roofers: 2, electricians: 1, color: "#f43f5e" }
  ]
};

const locations = ['All', 'Westminster', 'Centennial', 'Colorado Springs', 'San Luis Obispo', 'Camarillo'];
const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
const dayNames = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];

// ===== STATE =====
let state = {
  currentYear: 2026,
  currentMonth: 0,
  selectedProject: null,
  selectedStage: 'all',
  selectedLocation: 'All',
  currentView: 'calendar',
  manualSchedules: {}, // { projectId: { startDate, days, crew } }
  draggedProject: null
};

// ===== UTILITY FUNCTIONS =====
const utils = {
  formatDate(dateStr) {
    const date = new Date(dateStr + 'T12:00:00');
    return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
  },
  formatShortDate(dateStr) {
    if (!dateStr) return '';
    const d = new Date(dateStr + 'T12:00:00');
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  },
  formatCurrency(amount) {
    return '$' + (amount / 1000).toFixed(1) + 'K';
  },
  getCustomerName(fullName) {
    return fullName.split(' | ')[1] || fullName;
  },
  getProjectId(fullName) {
    return fullName.split(' | ')[0];
  },
  isWeekend(date) {
    const d = new Date(date);
    return d.getDay() === 0 || d.getDay() === 6;
  },
  addDays(dateStr, days) {
    const d = new Date(dateStr + 'T12:00:00');
    d.setDate(d.getDate() + days);
    return d.toISOString().split('T')[0];
  },
  getNextWorkday(dateStr) {
    let d = new Date(dateStr + 'T12:00:00');
    while (d.getDay() === 0 || d.getDay() === 6) {
      d.setDate(d.getDate() + 1);
    }
    return d.toISOString().split('T')[0];
  }
};

// ===== DATA FUNCTIONS =====
function getFilteredProjects() {
  const search = document.getElementById('searchInput')?.value?.toLowerCase() || '';
  const typeFilter = document.getElementById('typeFilter')?.value || '';
  const sortBy = document.getElementById('sortFilter')?.value || 'amount';

  let filtered = projects.filter(p => {
    if (state.selectedLocation !== 'All' && p.location !== state.selectedLocation) return false;
    if (state.selectedStage !== 'all' && p.stage !== state.selectedStage) return false;
    if (search && !p.name.toLowerCase().includes(search) && !p.address.toLowerCase().includes(search)) return false;
    if (typeFilter && (!p.type || !p.type.includes(typeFilter))) return false;
    return true;
  });

  // Sort
  if (sortBy === 'amount') filtered.sort((a, b) => b.amount - a.amount);
  else if (sortBy === 'date') filtered.sort((a, b) => (a.scheduleDate || 'z').localeCompare(b.scheduleDate || 'z'));
  else if (sortBy === 'days') filtered.sort((a, b) => (a.daysInstall || 1) - (b.daysInstall || 1));

  return filtered;
}

function getScheduledEvents() {
  const events = [];

  // Projects with existing schedule dates
  projects.forEach(p => {
    if (p.scheduleDate) {
      events.push({ ...p, date: p.scheduleDate, eventType: p.stage, days: p.daysInstall || 1 });
    }
  });

  // Manual schedules (override project schedule)
  Object.entries(state.manualSchedules).forEach(([id, data]) => {
    const project = projects.find(p => p.id === id);
    if (project) {
      // Remove existing event for this project
      const existingIdx = events.findIndex(e => e.id === id);
      if (existingIdx > -1) events.splice(existingIdx, 1);
      events.push({ ...project, date: data.startDate, eventType: 'scheduled', days: data.days, crew: data.crew });
    }
  });

  return events;
}

function getCrewScheduleForWeek(weekStart, crew, location) {
  const events = getScheduledEvents();
  const crewEvents = events.filter(e => e.crew === crew && e.location === location);
  const schedule = {};

  for (let i = 0; i < 7; i++) {
    const d = new Date(weekStart);
    d.setDate(d.getDate() + i);
    const dateStr = d.toISOString().split('T')[0];
    schedule[dateStr] = crewEvents.filter(e => {
      const eventStart = new Date(e.date);
      const eventEnd = new Date(e.date);
      eventEnd.setDate(eventEnd.getDate() + (e.days || 1) - 1);
      const checkDate = new Date(dateStr);
      return checkDate >= eventStart && checkDate <= eventEnd;
    });
  }

  return schedule;
}

function detectConflicts() {
  const events = getScheduledEvents();
  const conflicts = [];

  // Group events by crew and check for overlaps
  const crewSchedules = {};
  events.forEach(e => {
    if (!e.crew) return;
    if (!crewSchedules[e.crew]) crewSchedules[e.crew] = [];
    const start = new Date(e.date);
    for (let i = 0; i < (e.days || 1); i++) {
      const d = new Date(start);
      d.setDate(d.getDate() + i);
      const dateStr = d.toISOString().split('T')[0];
      crewSchedules[e.crew].push({ date: dateStr, project: e });
    }
  });

  Object.entries(crewSchedules).forEach(([crew, days]) => {
    const dateMap = {};
    days.forEach(d => {
      if (!dateMap[d.date]) dateMap[d.date] = [];
      dateMap[d.date].push(d.project);
    });

    Object.entries(dateMap).forEach(([date, projects]) => {
      if (projects.length > 1) {
        conflicts.push({
          crew,
          date,
          projects: projects.map(p => utils.getCustomerName(p.name))
        });
      }
    });
  });

  return conflicts;
}

// ===== RENDER FUNCTIONS =====
function renderLocationTabs() {
  const container = document.getElementById('locationTabs');
  container.innerHTML = locations.map(loc => {
    const locProjects = loc === 'All' ? projects : projects.filter(p => p.location === loc);
    const count = locProjects.length;
    const revenue = (locProjects.reduce((sum, p) => sum + p.amount, 0) / 1000).toFixed(0);
    return `<div class="location-tab ${state.selectedLocation === loc ? 'active' : ''}" onclick="selectLocation('${loc}')">
      ${loc === 'All' ? 'üåê All' : loc} <span class="count">${count}</span>
      <span class="revenue">$${revenue}K</span>
    </div>`;
  }).join('');
}

function renderStageTabs() {
  const container = document.getElementById('stageTabs');
  container.innerHTML = `
    <div class="stage-tab ${state.selectedStage === 'all' ? 'active' : ''}" onclick="selectStage('all')">All</div>
    <div class="stage-tab construction ${state.selectedStage === 'construction' ? 'active' : ''}" onclick="selectStage('construction')">üî® Build</div>
    <div class="stage-tab rtb ${state.selectedStage === 'rtb' ? 'active' : ''}" onclick="selectStage('rtb')">‚úÖ RTB</div>
    <div class="stage-tab blocked ${state.selectedStage === 'blocked' ? 'active' : ''}" onclick="selectStage('blocked')">‚ö†Ô∏è Blocked</div>
  `;
}

function renderStats() {
  const container = document.getElementById('statsBar');
  const filteredProjects = state.selectedLocation === 'All' ? projects : projects.filter(p => p.location === state.selectedLocation);

  const constructionCount = filteredProjects.filter(p => p.stage === 'construction').length;
  const rtbCount = filteredProjects.filter(p => p.stage === 'rtb').length;
  const blockedCount = filteredProjects.filter(p => p.stage === 'blocked').length;
  const scheduledCount = Object.keys(state.manualSchedules).length;
  const totalRevenue = (filteredProjects.reduce((sum, p) => sum + p.amount, 0) / 1000).toFixed(0);

  container.innerHTML = `
    <div class="stat"><div class="stat-dot" style="background: var(--construction);"></div><div class="stat-value">${constructionCount}</div><div class="stat-label">Building</div></div>
    <div class="stat"><div class="stat-dot" style="background: var(--rtb);"></div><div class="stat-value">${rtbCount}</div><div class="stat-label">RTB</div></div>
    <div class="stat"><div class="stat-dot" style="background: var(--rtb-blocked);"></div><div class="stat-value">${blockedCount}</div><div class="stat-label">Blocked</div></div>
    <div class="stat"><div class="stat-dot" style="background: var(--solar);"></div><div class="stat-value">${scheduledCount}</div><div class="stat-label">Scheduled</div></div>
    <div class="stat"><div class="stat-dot" style="background: var(--accent);"></div><div class="stat-value">$${totalRevenue}K</div><div class="stat-label">Pipeline</div></div>
  `;
}

function renderQueue() {
  const queue = getFilteredProjects();
  const container = document.getElementById('queueList');
  const totalRevenue = (queue.reduce((sum, p) => sum + p.amount, 0) / 1000).toFixed(0);

  document.getElementById('queueCount').innerHTML = `<span>${queue.length} projects</span><span>$${totalRevenue}K</span>`;

  container.innerHTML = queue.map(p => {
    const customerName = utils.getCustomerName(p.name);
    const types = (p.type || '').split(';').filter(t => t.trim());
    const stageLabel = p.stage === 'construction' ? 'üî®' : p.stage === 'rtb' ? '‚úÖ' : '‚ö†Ô∏è';
    const isScheduled = state.manualSchedules[p.id] || p.scheduleDate;
    const scheduleDate = state.manualSchedules[p.id]?.startDate || p.scheduleDate;

    return `
      <div class="queue-item ${p.stage} ${state.selectedProject?.id === p.id ? 'selected' : ''}"
           onclick="selectProject('${p.id}')"
           draggable="true"
           ondragstart="handleDragStart(event, '${p.id}')"
           ondragend="handleDragEnd(event)">
        <div class="queue-item-header">
          <div class="queue-item-name" title="${p.name}">${customerName}</div>
          <div class="queue-item-amount">${utils.formatCurrency(p.amount)}</div>
        </div>
        <div class="queue-item-address" title="${p.address}">${p.address}</div>
        <div class="queue-item-meta">
          <span class="queue-item-tag ${p.stage}">${stageLabel} ${p.stage}</span>
          ${isScheduled ? `<span class="queue-item-tag scheduled">üìÖ ${utils.formatShortDate(scheduleDate)}</span>` : ''}
          ${types.slice(0, 2).map(t => {
            const cls = t.toLowerCase().includes('solar') ? 'solar' : t.toLowerCase().includes('battery') ? 'battery' : '';
            return `<span class="queue-item-tag ${cls}">${t.trim()}</span>`;
          }).join('')}
        </div>
        <div class="queue-item-specs">
          ${p.systemSize ? `<span class="spec"><strong>${p.systemSize}</strong> kW</span>` : ''}
          ${p.batteries ? `<span class="spec"><strong>${p.batteries}</strong> batt</span>` : ''}
          ${p.daysInstall ? `<span class="spec"><strong>${p.daysInstall}</strong>d</span>` : ''}
          ${p.crew ? `<span class="spec">${p.crew}</span>` : ''}
        </div>
      </div>
    `;
  }).join('');
}

function renderCalendar() {
  const cal = document.getElementById('calendar');
  const firstDay = new Date(state.currentYear, state.currentMonth, 1);
  const lastDay = new Date(state.currentYear, state.currentMonth + 1, 0);
  const startDay = firstDay.getDay();
  const daysInMonth = lastDay.getDate();
  const today = new Date();

  let html = dayNames.map(d => `<div class="day-header">${d}</div>`).join('');

  const events = getScheduledEvents();
  const eventsByDate = {};

  events.forEach(e => {
    if (state.selectedLocation !== 'All' && e.location !== state.selectedLocation) return;

    const startDate = new Date(e.date);
    for (let i = 0; i < (e.days || 1); i++) {
      const eventDate = new Date(startDate);
      eventDate.setDate(eventDate.getDate() + i);

      if (eventDate.getMonth() === state.currentMonth && eventDate.getFullYear() === state.currentYear) {
        const day = eventDate.getDate();
        if (!eventsByDate[day]) eventsByDate[day] = [];
        eventsByDate[day].push({ ...e, dayNum: i + 1, totalDays: e.days || 1 });
      }
    }
  });

  // Previous month padding
  const prevDays = new Date(state.currentYear, state.currentMonth, 0).getDate();
  for (let i = startDay - 1; i >= 0; i--) {
    html += `<div class="day other-month"><div class="day-number">${prevDays - i}</div></div>`;
  }

  // Current month
  for (let day = 1; day <= daysInMonth; day++) {
    const currentDate = new Date(state.currentYear, state.currentMonth, day);
    const isToday = today.getDate() === day && today.getMonth() === state.currentMonth && today.getFullYear() === state.currentYear;
    const isWeekend = currentDate.getDay() === 0 || currentDate.getDay() === 6;
    const dayEvents = eventsByDate[day] || [];
    const dateStr = `${state.currentYear}-${String(state.currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    const canDrop = state.selectedProject || state.draggedProject;

    html += `<div class="day${isToday ? ' today' : ''}${canDrop ? ' drop-target' : ''}${isWeekend ? ' weekend' : ''}"
                  onclick="handleDayClick('${dateStr}')"
                  ondragover="handleDragOver(event)"
                  ondrop="handleDrop(event, '${dateStr}')">`;
    html += `<div class="day-number">${day}</div>`;

    dayEvents.slice(0, 4).forEach(e => {
      const shortName = utils.getCustomerName(e.name).substring(0, 8);
      const dayLabel = e.totalDays > 1 ? `D${e.dayNum} ` : '';
      html += `<div class="event ${e.eventType}" onclick="event.stopPropagation();showDetail('${e.id}')" title="${e.name} - ${e.crew || 'No crew'}">${dayLabel}${shortName}</div>`;
    });

    if (dayEvents.length > 4) {
      html += `<div class="more-events">+${dayEvents.length - 4}</div>`;
    }

    html += '</div>';
  }

  // Next month padding
  const total = startDay + daysInMonth;
  const rem = 7 - (total % 7);
  if (rem < 7) {
    for (let i = 1; i <= rem; i++) {
      html += `<div class="day other-month"><div class="day-number">${i}</div></div>`;
    }
  }

  cal.innerHTML = html;
  document.getElementById('monthTitle').textContent = `${monthNames[state.currentMonth]} ${state.currentYear}`;
}

function renderCrewCapacity() {
  const container = document.getElementById('crewCapacity');
  const loc = state.selectedLocation === 'All' ? null : state.selectedLocation;

  if (!loc || !crews[loc]) {
    container.innerHTML = '<div style="font-size: 0.65rem; color: var(--text-dim);">Select location to view crews</div>';
    return;
  }

  const events = getScheduledEvents().filter(e => e.location === loc);

  container.innerHTML = crews[loc].map(c => {
    // Calculate utilization for next 2 weeks
    const crewEvents = events.filter(e => e.crew === c.name);
    const totalDays = crewEvents.reduce((sum, e) => sum + (e.days || 1), 0);
    const utilization = Math.min(100, Math.round((totalDays / 10) * 100)); // 10 workdays in 2 weeks
    const utilizationClass = utilization > 90 ? 'full' : utilization > 70 ? 'warning' : '';

    return `
      <div class="crew-card">
        <div class="crew-name" style="color: ${c.color}">${c.name}</div>
        <div class="crew-capacity">
          ${c.roofers > 0 ? `<span class="capacity-item">üë∑ ${c.roofers}</span>` : ''}
          ${c.electricians > 0 ? `<span class="capacity-item">‚ö° ${c.electricians}</span>` : ''}
        </div>
        <div class="crew-utilization">
          <div style="display: flex; align-items: center; gap: 8px;">
            <div class="capacity-bar" style="width: 100px;">
              <div class="capacity-fill ${utilizationClass}" style="width: ${utilization}%;"></div>
            </div>
            <span>${utilization}% (${crewEvents.length} jobs)</span>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function renderConflicts() {
  const conflicts = detectConflicts();
  document.getElementById('conflictCount').textContent = conflicts.length;

  const container = document.getElementById('conflictList');
  if (conflicts.length === 0) {
    container.innerHTML = '<div style="font-size: 0.65rem; color: var(--text-dim);">‚úÖ No scheduling conflicts</div>';
    return;
  }

  container.innerHTML = conflicts.map(c => `
    <div class="conflict-item">
      <div class="conflict-title">‚ö†Ô∏è ${c.crew} - ${utils.formatShortDate(c.date)}</div>
      <div class="conflict-detail">${c.projects.join(', ')}</div>
    </div>
  `).join('');
}

// ===== EVENT HANDLERS =====
function selectLocation(loc) {
  state.selectedLocation = loc;
  renderAll();
}

function selectStage(stage) {
  state.selectedStage = stage;
  state.selectedProject = null;
  document.getElementById('instructions').style.display = 'none';
  renderStageTabs();
  renderQueue();
}

function selectProject(id) {
  state.selectedProject = projects.find(p => p.id === id);
  if (state.selectedProject && state.selectedProject.stage !== 'construction') {
    document.getElementById('instructions').style.display = 'block';
    document.getElementById('selectedProjectName').textContent = utils.getCustomerName(state.selectedProject.name);
  } else {
    document.getElementById('instructions').style.display = 'none';
  }
  renderQueue();
  renderCalendar();
}

function handleDayClick(dateStr) {
  if (!state.selectedProject || state.selectedProject.stage === 'construction') return;
  openScheduleModal(state.selectedProject, dateStr);
}

function handleDragStart(event, projectId) {
  state.draggedProject = projects.find(p => p.id === projectId);
  event.target.classList.add('dragging');
  event.dataTransfer.setData('text/plain', projectId);
}

function handleDragEnd(event) {
  state.draggedProject = null;
  event.target.classList.remove('dragging');
}

function handleDragOver(event) {
  event.preventDefault();
}

function handleDrop(event, dateStr) {
  event.preventDefault();
  const projectId = event.dataTransfer.getData('text/plain');
  const project = projects.find(p => p.id === projectId);
  if (project && project.stage !== 'construction') {
    openScheduleModal(project, dateStr);
  }
}

function openScheduleModal(project, dateStr) {
  const customerName = utils.getCustomerName(project.name);
  const types = (project.type || 'Service').split(';').filter(t => t.trim()).join(', ');
  const locationCrews = crews[project.location] || [];
  const crewOptions = locationCrews.map(c => `<option value="${c.name}" ${c.name === project.crew ? 'selected' : ''}>${c.name}</option>`).join('');

  document.getElementById('modalBody').innerHTML = `
    <div class="modal-section">
      <div class="modal-section-title">Project</div>
      <div class="modal-row"><span class="modal-label">Customer</span><span>${customerName}</span></div>
      <div class="modal-row"><span class="modal-label">Address</span><span>${project.address}</span></div>
      <div class="modal-row"><span class="modal-label">Location</span><span>${project.location}</span></div>
      <div class="modal-row"><span class="modal-label">Type</span><span>${types}</span></div>
      <div class="modal-row"><span class="modal-label">Amount</span><span style="color:var(--accent);font-weight:600;">$${project.amount.toLocaleString()}</span></div>
      <div class="modal-row"><span class="modal-label">Status</span><span style="color:${project.stage === 'rtb' ? 'var(--rtb)' : 'var(--rtb-blocked)'}">${project.stage === 'rtb' ? '‚úÖ RTB Ready' : '‚ö†Ô∏è Blocked'}</span></div>
    </div>
    <div class="modal-section">
      <div class="modal-section-title">Equipment</div>
      ${project.systemSize ? `<div class="modal-row"><span class="modal-label">System</span><span>${project.systemSize} kW</span></div>` : ''}
      ${project.batteries ? `<div class="modal-row"><span class="modal-label">Batteries</span><span>${project.batteries}x ${project.batteryModel || 'Tesla'}</span></div>` : ''}
      ${project.roofType ? `<div class="modal-row"><span class="modal-label">Roof</span><span>${project.roofType}</span></div>` : ''}
    </div>
    <div class="modal-section">
      <div class="modal-section-title">Schedule</div>
      <div class="modal-row"><span class="modal-label">Start Date</span><span><strong>${utils.formatDate(dateStr)}</strong></span></div>
      <div class="form-row">
        <label>Days:</label>
        <input type="number" id="installDays" value="${project.daysInstall || 2}" min="1" max="10">
        <label>Crew:</label>
        <select id="crewSelect">${crewOptions || '<option>No crews</option>'}</select>
      </div>
    </div>
  `;

  document.getElementById('modalOverlay').classList.add('visible');
  window.pendingSchedule = { project, date: dateStr };
}

function confirmSchedule() {
  if (!window.pendingSchedule) return;

  const { project, date } = window.pendingSchedule;
  const days = parseInt(document.getElementById('installDays').value) || 2;
  const crew = document.getElementById('crewSelect')?.value || project.crew;

  state.manualSchedules[project.id] = { startDate: date, days, crew };

  showToast(`‚úÖ ${utils.getCustomerName(project.name)} scheduled for ${utils.formatDate(date)}`);
  closeModal();
  state.selectedProject = null;
  document.getElementById('instructions').style.display = 'none';
  renderAll();
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('visible');
  window.pendingSchedule = null;
}

function showDetail(id) {
  const p = projects.find(proj => proj.id === id);
  if (!p) return;

  const customerName = utils.getCustomerName(p.name);
  const types = (p.type || 'Service').split(';').filter(t => t.trim()).join(', ');
  const scheduleInfo = state.manualSchedules[p.id] || (p.scheduleDate ? { startDate: p.scheduleDate, days: p.daysInstall, crew: p.crew } : null);

  document.getElementById('detailModalBody').innerHTML = `
    <div class="modal-section">
      <div class="modal-section-title">Project</div>
      <div class="modal-row"><span class="modal-label">ID</span><span>${utils.getProjectId(p.name)}</span></div>
      <div class="modal-row"><span class="modal-label">Customer</span><span>${customerName}</span></div>
      <div class="modal-row"><span class="modal-label">Address</span><span>${p.address}</span></div>
      <div class="modal-row"><span class="modal-label">Location</span><span>${p.location}</span></div>
      <div class="modal-row"><span class="modal-label">Type</span><span>${types}</span></div>
      <div class="modal-row"><span class="modal-label">Amount</span><span style="color:var(--accent);font-weight:600;">$${p.amount.toLocaleString()}</span></div>
    </div>
    <div class="modal-section">
      <div class="modal-section-title">Schedule</div>
      <div class="modal-row"><span class="modal-label">Date</span><span style="color:var(--construction);font-weight:600;">${scheduleInfo ? utils.formatDate(scheduleInfo.startDate) : 'Not scheduled'}</span></div>
      <div class="modal-row"><span class="modal-label">Duration</span><span>${scheduleInfo?.days || p.daysInstall || 2} days</span></div>
      <div class="modal-row"><span class="modal-label">Crew</span><span>${scheduleInfo?.crew || p.crew || 'Unassigned'}</span></div>
    </div>
  `;

  document.getElementById('hubspotLink').href = p.hubspotUrl;
  document.getElementById('detailModal').classList.add('visible');
}

function closeDetailModal() {
  document.getElementById('detailModal').classList.remove('visible');
}

// ===== AUTO-OPTIMIZE =====
function autoOptimize() {
  const rtbProjects = projects.filter(p => p.stage === 'rtb' && !state.manualSchedules[p.id] && !p.scheduleDate);

  if (rtbProjects.length === 0) {
    showToast('No unscheduled RTB projects to optimize', 'error');
    return;
  }

  // Sort by revenue (highest first)
  rtbProjects.sort((a, b) => b.amount - a.amount);

  // Get next available dates per crew
  const crewNextDate = {};
  let baseDate = new Date();
  baseDate.setDate(baseDate.getDate() + 1); // Start tomorrow

  // Initialize crew dates
  Object.values(crews).flat().forEach(c => {
    crewNextDate[c.name] = utils.getNextWorkday(baseDate.toISOString().split('T')[0]);
  });

  // Existing schedules affect crew availability
  getScheduledEvents().forEach(e => {
    if (e.crew && crewNextDate[e.crew]) {
      const endDate = utils.addDays(e.date, e.days || 1);
      if (endDate > crewNextDate[e.crew]) {
        crewNextDate[e.crew] = utils.getNextWorkday(endDate);
      }
    }
  });

  let scheduled = 0;
  rtbProjects.forEach(p => {
    const preferredCrew = p.crew;
    if (preferredCrew && crewNextDate[preferredCrew]) {
      const startDate = crewNextDate[preferredCrew];
      state.manualSchedules[p.id] = { startDate, days: p.daysInstall || 2, crew: preferredCrew };
      crewNextDate[preferredCrew] = utils.getNextWorkday(utils.addDays(startDate, p.daysInstall || 2));
      scheduled++;
    }
  });

  showToast(`‚ö° Auto-scheduled ${scheduled} projects by revenue priority`);
  document.getElementById('optimizeStats').innerHTML = `Scheduled ${scheduled} projects<br>Total: $${(rtbProjects.slice(0, scheduled).reduce((s, p) => s + p.amount, 0) / 1000).toFixed(0)}K`;
  renderAll();
}

// ===== EXPORT FUNCTIONS =====
function exportCSV() {
  const events = getScheduledEvents();
  const headers = ['Project ID', 'Customer', 'Address', 'Location', 'Amount', 'Type', 'Stage', 'Schedule Date', 'Days', 'Crew'];

  let csv = headers.join(',') + '\n';
  events.forEach(e => {
    csv += [
      utils.getProjectId(e.name),
      `"${utils.getCustomerName(e.name)}"`,
      `"${e.address}"`,
      e.location,
      e.amount,
      `"${e.type || ''}"`,
      e.stage,
      e.date,
      e.days || e.daysInstall || 2,
      e.crew || ''
    ].join(',') + '\n';
  });

  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `pb-schedule-${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  showToast('üì• CSV exported');
}

function exportICal() {
  const events = getScheduledEvents();
  let ical = 'BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//PB Scheduler//EN\n';

  events.forEach(e => {
    const start = e.date.replace(/-/g, '');
    const end = utils.addDays(e.date, e.days || 1).replace(/-/g, '');
    ical += `BEGIN:VEVENT\nDTSTART;VALUE=DATE:${start}\nDTEND;VALUE=DATE:${end}\nSUMMARY:${utils.getCustomerName(e.name)} - ${e.crew || 'Unassigned'}\nDESCRIPTION:${e.address}\\n$${e.amount.toLocaleString()}\nEND:VEVENT\n`;
  });

  ical += 'END:VCALENDAR';

  const blob = new Blob([ical], { type: 'text/calendar' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'pb-schedule.ics';
  a.click();
  showToast('üìÖ iCal exported');
}

function copySchedule() {
  const events = getScheduledEvents();
  let text = 'PB Install Schedule\n==================\n\n';

  events.forEach(e => {
    text += `${utils.formatDate(e.date)} - ${utils.getCustomerName(e.name)}\n`;
    text += `  ${e.address}\n`;
    text += `  Crew: ${e.crew || 'Unassigned'} | ${e.days || e.daysInstall || 2} days | $${e.amount.toLocaleString()}\n\n`;
  });

  navigator.clipboard.writeText(text);
  showToast('üìã Copied to clipboard');
}

// ===== VIEW SWITCHING =====
let weekOffset = 0; // Weeks from current week

function switchView(view) {
  state.currentView = view;
  document.querySelectorAll('.view-tab').forEach(t => t.classList.remove('active'));
  document.querySelector(`[data-view="${view}"]`).classList.add('active');

  document.getElementById('calendarView').classList.toggle('hidden', view !== 'calendar');
  document.getElementById('weekView').classList.toggle('active', view === 'week');
  document.getElementById('ganttView').classList.toggle('active', view === 'gantt');

  if (view === 'week') renderWeekView();
  if (view === 'gantt') renderGanttView();
}

function getWeekDates(offset = 0) {
  const today = new Date(2026, 0, 13); // Use Jan 13, 2026 as base
  const start = new Date(today);
  start.setDate(start.getDate() - start.getDay() + 1 + (offset * 7)); // Start on Monday
  const dates = [];
  for (let i = 0; i < 5; i++) { // Monday through Friday
    const d = new Date(start);
    d.setDate(d.getDate() + i);
    dates.push(d);
  }
  return dates;
}

function prevWeek() {
  weekOffset--;
  renderWeekView();
}

function nextWeek() {
  weekOffset++;
  renderWeekView();
}

function renderWeekView() {
  const dates = getWeekDates(weekOffset);
  const container = document.getElementById('weekGrid');
  const today = new Date();

  // Update title
  const startDate = dates[0];
  const endDate = dates[4];
  document.getElementById('weekTitle').textContent =
    `Week of ${startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;

  // Get crews for selected location
  const loc = state.selectedLocation === 'All' ? 'Westminster' : state.selectedLocation;
  const locationCrews = crews[loc] || [];

  // Header row
  let html = '<div class="week-header" style="background: var(--bg);"></div>';
  dates.forEach(d => {
    const isToday = d.toDateString() === today.toDateString();
    html += `<div class="week-header${isToday ? ' today' : ''}">
      ${d.toLocaleDateString('en-US', { weekday: 'short' })}
      <span class="date-num">${d.getDate()}</span>
    </div>`;
  });

  // Crew rows
  const events = getScheduledEvents();
  locationCrews.forEach(crew => {
    // Calculate crew's weekly stats
    let weekProjects = 0;
    let weekRevenue = 0;

    html += `<div class="crew-row-header" style="border-right-color: ${crew.color};">
      <span class="crew-name">${crew.name}</span>
      <span class="crew-stats">üë∑ ${crew.roofers} | ‚ö° ${crew.electricians}</span>
    </div>`;

    dates.forEach(d => {
      const dateStr = d.toISOString().split('T')[0];
      const dayEvents = events.filter(e => {
        if (e.crew !== crew.name) return false;
        const eventStart = new Date(e.date);
        const eventEnd = new Date(e.date);
        eventEnd.setDate(eventEnd.getDate() + (e.days || 1) - 1);
        return d >= eventStart && d <= eventEnd;
      });

      const canDrop = state.selectedProject || state.draggedProject;
      html += `<div class="week-cell${canDrop ? ' drop-target' : ''}"
                    data-date="${dateStr}"
                    data-crew="${crew.name}"
                    onclick="handleWeekCellClick('${dateStr}', '${crew.name}')"
                    ondragover="handleDragOver(event)"
                    ondrop="handleWeekDrop(event, '${dateStr}', '${crew.name}')">`;

      dayEvents.forEach(e => {
        const dayNum = Math.floor((d - new Date(e.date)) / (1000*60*60*24)) + 1;
        const shortName = utils.getCustomerName(e.name).substring(0, 10);
        html += `<div class="event ${e.eventType || e.stage}" onclick="event.stopPropagation();showDetail('${e.id}')" title="${e.name}">
          ${e.days > 1 ? `D${dayNum} ` : ''}${shortName}
        </div>`;
      });

      html += '</div>';
    });
  });

  container.innerHTML = html;
}

function handleWeekCellClick(dateStr, crewName) {
  if (!state.selectedProject || state.selectedProject.stage === 'construction') return;
  // Pre-fill crew
  const project = { ...state.selectedProject, crew: crewName };
  state.selectedProject = project;
  openScheduleModal(state.selectedProject, dateStr);
}

function handleWeekDrop(event, dateStr, crewName) {
  event.preventDefault();
  const projectId = event.dataTransfer.getData('text/plain');
  const project = projects.find(p => p.id === projectId);
  if (project && project.stage !== 'construction') {
    // Pre-fill crew from drop target
    project.crew = crewName;
    openScheduleModal(project, dateStr);
  }
}

// ===== GANTT VIEW =====
function getGanttDates() {
  const start = new Date(2026, 0, 13); // Jan 13, 2026
  const dates = [];
  let current = new Date(start);
  for (let i = 0; i < 14; i++) { // 2 weeks
    if (current.getDay() !== 0 && current.getDay() !== 6) { // Skip weekends
      dates.push(new Date(current));
    }
    current.setDate(current.getDate() + 1);
    if (dates.length < 14 && (current.getDay() === 0 || current.getDay() === 6)) {
      current.setDate(current.getDate() + (current.getDay() === 0 ? 1 : 2));
    }
  }
  return dates.slice(0, 10); // 10 workdays
}

function renderGanttView() {
  const container = document.getElementById('ganttGrid');
  const dates = getGanttDates();
  const today = new Date();

  // Get all crews for selected location
  const loc = state.selectedLocation === 'All' ? null : state.selectedLocation;
  const allCrews = loc ? (crews[loc] || []) : Object.values(crews).flat();

  // Header row with dates
  let html = '<div class="gantt-timeline">';
  html += '<div class="gantt-day-header" style="background: var(--bg); font-weight: 600;">Crew</div>';
  dates.forEach(d => {
    const isToday = d.toDateString() === today.toDateString();
    html += `<div class="gantt-day-header${isToday ? ' today' : ''}">
      <span class="day-name">${d.toLocaleDateString('en-US', { weekday: 'short' })}</span>
      <span class="day-num">${d.getDate()}</span>
    </div>`;
  });
  html += '</div>';

  // Get all scheduled events
  const events = getScheduledEvents();

  // Crew rows
  allCrews.forEach(crew => {
    html += '<div class="gantt-row">';
    html += `<div class="gantt-crew-header" style="border-left: 3px solid ${crew.color};">${crew.name}</div>`;

    // Create cells for each day
    dates.forEach((d, idx) => {
      html += `<div class="gantt-cell" data-date="${d.toISOString().split('T')[0]}" data-crew="${crew.name}">`;

      // Find events that start on this day for this crew
      events.forEach(e => {
        if (e.crew !== crew.name) return;
        const eventStart = new Date(e.date);
        if (eventStart.toDateString() === d.toDateString()) {
          const days = e.days || 1;
          const widthPercent = (days / 10) * 100 * 10; // Relative to cell width
          const shortName = utils.getCustomerName(e.name).substring(0, 12);
          const amount = utils.formatCurrency(e.amount);
          html += `<div class="gantt-bar ${e.eventType || e.stage}"
                        style="left: 0; width: calc(${days * 100}% + ${(days-1)}px);"
                        onclick="showDetail('${e.id}')"
                        title="${e.name} - ${days} days - ${amount}">
            ${shortName} (${days}d)
          </div>`;
        }
      });

      html += '</div>';
    });

    html += '</div>';
  });

  container.innerHTML = html;
}

// ===== NAVIGATION =====
function prevMonth() {
  state.currentMonth--;
  if (state.currentMonth < 0) { state.currentMonth = 11; state.currentYear--; }
  renderCalendar();
}

function nextMonth() {
  state.currentMonth++;
  if (state.currentMonth > 11) { state.currentMonth = 0; state.currentYear++; }
  renderCalendar();
}

function goToToday() {
  const today = new Date();
  state.currentYear = today.getFullYear();
  state.currentMonth = today.getMonth();
  renderCalendar();
}

// ===== TOAST =====
function showToast(message, type = 'success') {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.className = `toast visible ${type === 'error' ? 'error' : ''}`;
  setTimeout(() => toast.classList.remove('visible'), 3000);
}

// ===== RENDER ALL =====
function renderAll() {
  renderLocationTabs();
  renderStageTabs();
  renderStats();
  renderQueue();
  renderCalendar();
  renderCrewCapacity();
  renderConflicts();
}

// ===== EVENT LISTENERS =====
document.getElementById('searchInput')?.addEventListener('input', renderQueue);
document.getElementById('typeFilter')?.addEventListener('change', renderQueue);
document.getElementById('sortFilter')?.addEventListener('change', renderQueue);

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
  // Escape to close modals and deselect
  if (e.key === 'Escape') {
    if (document.getElementById('modalOverlay').classList.contains('visible')) {
      closeModal();
    } else if (document.getElementById('detailModal').classList.contains('visible')) {
      closeDetailModal();
    } else if (state.selectedProject) {
      state.selectedProject = null;
      document.getElementById('instructions').style.display = 'none';
      renderQueue();
      renderCalendar();
    }
  }

  // View switching with number keys
  if (e.key === '1' && !e.ctrlKey && !e.metaKey) switchView('calendar');
  if (e.key === '2' && !e.ctrlKey && !e.metaKey) switchView('week');
  if (e.key === '3' && !e.ctrlKey && !e.metaKey) switchView('gantt');

  // Navigation with arrow keys
  if (e.key === 'ArrowLeft' && e.altKey) {
    if (state.currentView === 'calendar') prevMonth();
    if (state.currentView === 'week') prevWeek();
  }
  if (e.key === 'ArrowRight' && e.altKey) {
    if (state.currentView === 'calendar') nextMonth();
    if (state.currentView === 'week') nextWeek();
  }

  // Quick optimize with O key
  if (e.key === 'o' && (e.ctrlKey || e.metaKey)) {
    e.preventDefault();
    autoOptimize();
  }

  // Quick export with E key
  if (e.key === 'e' && (e.ctrlKey || e.metaKey)) {
    e.preventDefault();
    exportCSV();
  }
});

// Click outside modal to close
document.getElementById('modalOverlay').addEventListener('click', (e) => {
  if (e.target.id === 'modalOverlay') closeModal();
});
document.getElementById('detailModal').addEventListener('click', (e) => {
  if (e.target.id === 'detailModal') closeDetailModal();
});

// ===== INIT =====
try {
  renderAll();
} catch (e) {
  console.error('Failed to initialize scheduler:', e);
  document.querySelector('.main').innerHTML = `
    <div style="padding: 2rem; text-align: center; color: var(--conflict);">
      <h2>Failed to Load Scheduler</h2>
      <p style="margin-top: 1rem;">Please refresh the page or contact support.</p>
      <pre style="margin-top: 1rem; font-size: 0.7rem; color: var(--text-dim);">${e.message}</pre>
    </div>
  `;
}

// Show keyboard shortcuts hint
console.log(`
‚å®Ô∏è PB Scheduler Keyboard Shortcuts:
  1, 2, 3 - Switch views (Month, Week, Gantt)
  Alt+‚Üê / Alt+‚Üí - Navigate prev/next
  Ctrl+O - Auto-optimize schedule
  Ctrl+E - Export to CSV
  Escape - Close modals / Deselect
`);

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
  // Clear any pending timers
  if (window.toastTimeout) clearTimeout(window.toastTimeout);
});

// Performance: Use passive event listeners for scroll
document.querySelector('.queue-list')?.addEventListener('scroll', () => {}, { passive: true });
</script>
</body>
</html>
