<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Photon Brothers Command Center - Unified pipeline management, scheduling, and Participate Energy tracking">
<meta name="theme-color" content="#0a0a0f">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>PB Command Center | Photon Brothers</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #0a0a0f;
  --surface: #12121a;
  --surface-hover: #1a1a24;
  --border: #1e1e2e;
  --text: #e4e4e7;
  --text-dim: #71717a;
  --accent: #f97316;
  --accent-dim: rgba(249, 115, 22, 0.15);
  --pe-green: #10b981;
  --pe-dim: rgba(16, 185, 129, 0.15);
  --rtb: #10b981;
  --warning: #eab308;
  --danger: #ef4444;
  --info: #3b82f6;
  --purple: #8b5cf6;
}
body { font-family: 'Space Grotesk', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

/* Navigation */
.top-nav { background: linear-gradient(135deg, var(--surface), #1a1a28); border-bottom: 1px solid var(--border); padding: 1rem 1.5rem; position: sticky; top: 0; z-index: 100; }
.nav-row { display: flex; justify-content: space-between; align-items: center; }
.logo { font-size: 1.4rem; font-weight: 700; background: linear-gradient(135deg, var(--accent), #fb923c); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.logo-sub { font-size: 0.65rem; color: var(--text-dim); }
.nav-tabs { display: flex; gap: 4px; margin-top: 1rem; }
.nav-tab { padding: 10px 20px; font-size: 0.8rem; font-weight: 600; border-radius: 8px 8px 0 0; cursor: pointer; background: var(--bg); border: 1px solid var(--border); border-bottom: none; color: var(--text-dim); transition: all 0.15s; }
.nav-tab:hover { color: var(--text); }
.nav-tab.active { background: var(--surface); color: var(--accent); border-color: var(--accent); border-bottom: 1px solid var(--surface); margin-bottom: -1px; }
.nav-tab .badge { background: var(--danger); color: white; font-size: 0.6rem; padding: 2px 6px; border-radius: 10px; margin-left: 6px; }
.nav-tab .pe-badge { background: var(--pe-green); }

/* Main Content */
.main-content { padding: 1.5rem; }
.view-panel { display: none; }
.view-panel.active { display: block; }

/* Stats Grid */
.stats-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
.stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 1rem; }
.stat-card.accent { border-color: var(--accent); background: var(--accent-dim); }
.stat-card.pe { border-color: var(--pe-green); background: var(--pe-dim); }
.stat-card.danger { border-color: var(--danger); background: rgba(239, 68, 68, 0.1); }
.stat-value { font-size: 2rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
.stat-label { font-size: 0.7rem; color: var(--text-dim); margin-top: 4px; }
.stat-sub { font-size: 0.65rem; color: var(--text-dim); margin-top: 2px; }

/* Filters Bar */
.filters-bar { display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; align-items: center; background: var(--surface); padding: 1rem; border-radius: 12px; border: 1px solid var(--border); }
.filter-group { display: flex; align-items: center; gap: 8px; }
.filter-label { font-size: 0.7rem; color: var(--text-dim); }
.filter-select, .filter-input { background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 8px 12px; border-radius: 6px; font-family: inherit; font-size: 0.75rem; }
.filter-select:focus, .filter-input:focus { outline: none; border-color: var(--accent); }
.filter-btn { padding: 8px 16px; border-radius: 6px; font-family: inherit; font-size: 0.75rem; cursor: pointer; border: 1px solid var(--border); background: var(--bg); color: var(--text); transition: all 0.15s; }
.filter-btn:hover { border-color: var(--accent); color: var(--accent); }
.filter-btn.active { background: var(--accent); border-color: var(--accent); color: #000; }
.filter-btn.pe-filter.active { background: var(--pe-green); border-color: var(--pe-green); }

/* Project Table */
.table-container { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
.table-header { display: grid; grid-template-columns: 50px 2fr 1fr 100px 100px 100px 100px 80px 120px; gap: 8px; padding: 12px 16px; background: var(--bg); border-bottom: 1px solid var(--border); font-size: 0.7rem; font-weight: 600; color: var(--text-dim); }
.table-row { display: grid; grid-template-columns: 50px 2fr 1fr 100px 100px 100px 100px 80px 120px; gap: 8px; padding: 12px 16px; border-bottom: 1px solid var(--border); font-size: 0.75rem; align-items: center; transition: background 0.15s; }
.table-row:hover { background: var(--surface-hover); }
.table-row.pe-row { border-left: 3px solid var(--pe-green); }
.table-row.overdue { background: rgba(239, 68, 68, 0.05); }
.table-body { max-height: 500px; overflow-y: auto; }

/* Badges */
.badge { font-size: 0.6rem; padding: 3px 8px; border-radius: 12px; font-weight: 600; }
.badge-pe { background: var(--pe-dim); color: var(--pe-green); border: 1px solid var(--pe-green); }
.badge-rtb { background: rgba(16, 185, 129, 0.2); color: var(--rtb); }
.badge-overdue { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
.badge-warning { background: rgba(234, 179, 8, 0.2); color: var(--warning); }
.badge-ok { background: rgba(16, 185, 129, 0.2); color: var(--rtb); }

/* Days indicator */
.days-indicator { font-family: 'JetBrains Mono', monospace; font-weight: 600; font-size: 0.75rem; }
.days-indicator.overdue { color: var(--danger); }
.days-indicator.warning { color: var(--warning); }
.days-indicator.ok { color: var(--rtb); }

/* Priority Score */
.priority-bar { width: 100%; height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; }
.priority-fill { height: 100%; border-radius: 3px; transition: width 0.3s; }

/* Capacity View */
.capacity-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
.capacity-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem; }
.capacity-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
.capacity-title { font-size: 1rem; font-weight: 600; }
.capacity-crews { font-size: 0.7rem; color: var(--text-dim); }
.capacity-chart { height: 200px; margin-bottom: 1rem; }
.capacity-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
.cap-stat { text-align: center; padding: 8px; background: var(--bg); border-radius: 6px; }
.cap-stat-value { font-size: 1.2rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
.cap-stat-label { font-size: 0.6rem; color: var(--text-dim); }

/* Scheduler View */
.scheduler-grid { display: grid; grid-template-columns: 350px 1fr; gap: 1.5rem; }
.queue-panel { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; max-height: 700px; display: flex; flex-direction: column; }
.queue-header { padding: 1rem; border-bottom: 1px solid var(--border); }
.queue-title { font-size: 0.9rem; font-weight: 600; margin-bottom: 0.5rem; }
.queue-filters { display: flex; gap: 4px; flex-wrap: wrap; }
.queue-tab { padding: 6px 10px; font-size: 0.65rem; border-radius: 6px; cursor: pointer; background: var(--bg); border: 1px solid var(--border); color: var(--text-dim); }
.queue-tab:hover { border-color: var(--text-dim); }
.queue-tab.active { border-color: var(--accent); color: var(--accent); background: var(--accent-dim); }
.queue-list { flex: 1; overflow-y: auto; padding: 0.75rem; }
.queue-item { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 0.75rem; margin-bottom: 0.5rem; cursor: grab; transition: all 0.15s; }
.queue-item:hover { border-color: var(--accent); transform: translateX(3px); }
.queue-item.pe { border-left: 3px solid var(--pe-green); }
.queue-item-header { display: flex; justify-content: space-between; margin-bottom: 4px; }
.queue-item-name { font-size: 0.75rem; font-weight: 600; }
.queue-item-amount { font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: var(--accent); }
.queue-item-meta { font-size: 0.65rem; color: var(--text-dim); margin-bottom: 6px; }
.queue-item-tags { display: flex; gap: 4px; flex-wrap: wrap; }
.queue-item-tag { font-size: 0.55rem; padding: 2px 6px; border-radius: 4px; background: var(--border); }

/* Calendar */
.calendar-panel { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 1rem; }
.calendar-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
.calendar-title { font-size: 1.1rem; font-weight: 600; }
.calendar-btn { padding: 6px 12px; background: var(--bg); border: 1px solid var(--border); color: var(--text); border-radius: 6px; cursor: pointer; font-size: 0.75rem; }
.calendar-btn:hover { border-color: var(--accent); }
.calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; background: var(--border); border-radius: 8px; overflow: hidden; }
.calendar-day-header { background: var(--bg); padding: 8px; text-align: center; font-size: 0.7rem; font-weight: 600; color: var(--text-dim); }
.calendar-day { background: var(--surface); min-height: 80px; padding: 4px; cursor: pointer; transition: background 0.15s; }
.calendar-day:hover { background: var(--surface-hover); }
.calendar-day.today { box-shadow: inset 0 0 0 2px var(--accent); }
.calendar-day.other-month { opacity: 0.4; }
.calendar-day-num { font-size: 0.7rem; font-weight: 600; color: var(--text-dim); margin-bottom: 4px; }
.calendar-event { font-size: 0.55rem; padding: 2px 4px; border-radius: 3px; margin-bottom: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: pointer; }
.calendar-event.pe { background: var(--pe-green); color: #fff; }
.calendar-event.regular { background: var(--info); color: #fff; }
.calendar-event.overdue { background: var(--danger); color: #fff; }

/* PE Reporting View */
.pe-dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
.pe-card { background: var(--surface); border: 1px solid var(--pe-green); border-radius: 12px; padding: 1.25rem; }
.pe-card-title { font-size: 0.9rem; font-weight: 600; color: var(--pe-green); margin-bottom: 1rem; display: flex; align-items: center; gap: 8px; }
.pe-milestone-list { max-height: 300px; overflow-y: auto; }
.pe-milestone-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg); border-radius: 6px; margin-bottom: 6px; }
.pe-export-btn { width: 100%; padding: 12px; background: var(--pe-green); border: none; color: #fff; font-weight: 600; border-radius: 8px; cursor: pointer; font-family: inherit; font-size: 0.85rem; margin-top: 1rem; }
.pe-export-btn:hover { background: #0d9668; }

/* Optimization Panel */
.optimize-panel { background: linear-gradient(135deg, var(--surface), #1a1a28); border: 1px solid var(--accent); border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem; }
.optimize-title { font-size: 1rem; font-weight: 600; color: var(--accent); margin-bottom: 0.75rem; }
.optimize-btn { padding: 12px 24px; background: linear-gradient(135deg, var(--accent), #fb923c); border: none; color: #000; font-weight: 700; border-radius: 8px; cursor: pointer; font-family: inherit; font-size: 0.85rem; transition: all 0.15s; }
.optimize-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(249, 115, 22, 0.4); }
.optimize-stats { margin-top: 1rem; display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; }
.opt-stat { text-align: center; }
.opt-stat-value { font-size: 1.5rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
.opt-stat-label { font-size: 0.65rem; color: var(--text-dim); }

/* Revenue View */
.revenue-table { width: 100%; }
.revenue-row { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; padding: 12px 0; border-bottom: 1px solid var(--border); align-items: center; }
.revenue-row.header { font-weight: 600; font-size: 0.7rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; }
.revenue-row:last-child { border-bottom: none; }
.revenue-row.total { font-weight: 700; background: var(--bg); padding: 12px; border-radius: 8px; margin-top: 8px; }
.revenue-stage { font-weight: 500; }
.revenue-amount { font-family: 'JetBrains Mono', monospace; font-weight: 600; color: var(--accent); }
.revenue-count { font-size: 0.8rem; color: var(--text-dim); }
.revenue-bar { height: 8px; background: var(--bg); border-radius: 4px; overflow: hidden; }
.revenue-bar-fill { height: 100%; border-radius: 4px; transition: width 0.3s ease; }
.location-revenue-row { display: grid; grid-template-columns: 1.5fr 1fr 1fr 1fr 1fr; padding: 10px 0; border-bottom: 1px solid var(--border); font-size: 0.85rem; }
.timeline-row { display: grid; grid-template-columns: 1.2fr 1fr 1fr 80px; padding: 10px 0; border-bottom: 1px solid var(--border); font-size: 0.85rem; align-items: center; }
.timeline-row.header { font-weight: 600; font-size: 0.7rem; color: var(--text-dim); }

/* Responsive */
@media (max-width: 1200px) { .stats-grid { grid-template-columns: repeat(3, 1fr); } .scheduler-grid { grid-template-columns: 1fr; } }
@media (max-width: 768px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } .table-header, .table-row { grid-template-columns: 1fr; } }

/* Scrollbar */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }

/* Link */
a { color: var(--info); text-decoration: none; }
a:hover { text-decoration: underline; }
</style>
</head>
<body>

<nav class="top-nav">
  <div class="nav-row">
    <div>
      <div class="logo">PB Command Center</div>
      <div class="logo-sub">Unified Pipeline & Scheduling System - Live Data</div>
    </div>
    <div style="text-align: right; font-size: 0.7rem; color: var(--text-dim);">
      <div id="lastUpdated"></div>
      <div id="totalValue"></div>
    </div>
  </div>
  <div class="nav-tabs">
    <div class="nav-tab active" data-view="pipeline" onclick="switchView('pipeline')">Pipeline Overview</div>
    <div class="nav-tab" data-view="revenue" onclick="switchView('revenue')">Revenue</div>
    <div class="nav-tab" data-view="capacity" onclick="switchView('capacity')">Capacity Planning</div>
    <div class="nav-tab" data-view="scheduler" onclick="switchView('scheduler')">Scheduler</div>
    <div class="nav-tab" data-view="pe" onclick="switchView('pe')">Participate Energy <span class="badge pe-badge" id="peCount">0</span></div>
    <div class="nav-tab" data-view="alerts" onclick="switchView('alerts')">Alerts <span class="badge" id="alertCount">0</span></div>
  </div>
</nav>

<main class="main-content">
  <!-- Pipeline Overview -->
  <div class="view-panel active" id="pipelineView">
    <div class="stats-grid" id="pipelineStats"></div>
    <div class="filters-bar" id="pipelineFilters"></div>
    <div class="table-container">
      <div class="table-header">
        <div>#</div>
        <div>Project</div>
        <div>Location / AHJ</div>
        <div>Value</div>
        <div>Install</div>
        <div>Inspection</div>
        <div>PTO</div>
        <div>Priority</div>
        <div>Actions</div>
      </div>
      <div class="table-body" id="pipelineTable"></div>
    </div>
  </div>

  <!-- Revenue View -->
  <div class="view-panel" id="revenueView">
    <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);" id="revenueStats"></div>

    <!-- Revenue by Stage -->
    <div style="background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem; margin-top: 1.5rem;">
      <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem; color: var(--accent);">Revenue by Deal Stage</h3>
      <div id="stageRevenueTable"></div>
    </div>

    <!-- Revenue by Location + Timeline -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 1.5rem;">
      <div style="background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem;">
        <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem; color: var(--accent);">Scheduled Revenue by Location</h3>
        <div id="locationRevenueTable"></div>
      </div>
      <div style="background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem;">
        <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem; color: var(--accent);">Revenue Forecast Timeline</h3>
        <div style="display: flex; gap: 8px; margin-bottom: 1rem;">
          <button class="filter-btn active" id="weeklyBtn" onclick="setRevenueView('weekly')">Weekly</button>
          <button class="filter-btn" id="monthlyBtn" onclick="setRevenueView('monthly')">Monthly</button>
        </div>
        <div id="revenueTimeline"></div>
      </div>
    </div>
  </div>

  <!-- Capacity Planning -->
  <div class="view-panel" id="capacityView">
    <div class="optimize-panel">
      <div class="optimize-title">AI Capacity Optimizer</div>
      <p style="font-size: 0.75rem; color: var(--text-dim); margin-bottom: 1rem;">Analyze forecasted installs vs. available crew capacity across all locations</p>
      <button class="optimize-btn" onclick="runCapacityOptimization()">Analyze Capacity Gaps</button>
      <div class="optimize-stats" id="capacityOptStats"></div>
    </div>
    <div class="capacity-grid" id="capacityGrid"></div>
  </div>

  <!-- Scheduler -->
  <div class="view-panel" id="schedulerView">
    <div class="scheduler-grid">
      <div class="queue-panel">
        <div class="queue-header">
          <div class="queue-title">Ready to Schedule</div>
          <div class="queue-filters">
            <div class="queue-tab active" data-filter="all" onclick="filterQueue('all')">All</div>
            <div class="queue-tab" data-filter="rtb" onclick="filterQueue('rtb')">RTB</div>
            <div class="queue-tab" data-filter="pe" onclick="filterQueue('pe')">PE</div>
            <div class="queue-tab" data-filter="priority" onclick="filterQueue('priority')">High Priority</div>
          </div>
        </div>
        <div style="padding: 0.5rem 0.75rem; font-size: 0.65rem; color: var(--text-dim); background: var(--bg); border-bottom: 1px solid var(--border);" id="queueCount">0 projects</div>
        <div class="queue-list" id="queueList"></div>
      </div>
      <div class="calendar-panel">
        <div class="calendar-nav">
          <button class="calendar-btn" onclick="prevMonth()">Prev</button>
          <div class="calendar-title" id="calendarTitle">January 2026</div>
          <button class="calendar-btn" onclick="nextMonth()">Next</button>
        </div>
        <div class="calendar-grid" id="calendarGrid"></div>
      </div>
    </div>
  </div>

  <!-- PE Reporting -->
  <div class="view-panel" id="peView">
    <div class="stats-grid" style="grid-template-columns: repeat(5, 1fr);" id="peStats"></div>
    <div class="pe-dashboard">
      <div class="pe-card">
        <div class="pe-card-title">Inspection Complete (Milestone 1)</div>
        <div class="pe-milestone-list" id="peInspectionList"></div>
      </div>
      <div class="pe-card">
        <div class="pe-card-title">Project Complete / PTO (Milestone 2)</div>
        <div class="pe-milestone-list" id="pePtoList"></div>
      </div>
      <div class="pe-card" style="grid-column: span 2;">
        <div class="pe-card-title">Export for Participate Energy</div>
        <p style="font-size: 0.75rem; color: var(--text-dim); margin-bottom: 1rem;">Generate reports with forecasted and scheduled dates for PE submission</p>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
          <button class="pe-export-btn" onclick="exportPEReport('excel')">Download Excel</button>
          <button class="pe-export-btn" onclick="exportPEReport('csv')">Download CSV</button>
          <button class="pe-export-btn" onclick="exportPEReport('clipboard')">Copy to Clipboard</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Alerts -->
  <div class="view-panel" id="alertsView">
    <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);" id="alertStats"></div>
    <div id="alertsList"></div>
  </div>
</main>

<script>
// ============================================================
// PB COMMAND CENTER - Live API Integration
// ============================================================

// Static crew configuration per location
const CREWS_CONFIG = {
  "Westminster": {
    crews: [
      { name: "WM Crew 1", roofers: 2, electricians: 1, color: "#3b82f6", dailyCapacity: 1 },
      { name: "WM Crew 2", roofers: 2, electricians: 1, color: "#8b5cf6", dailyCapacity: 1 }
    ],
    monthly_capacity: 44
  },
  "Centennial": {
    crews: [
      { name: "CENT Crew", roofers: 2, electricians: 1, color: "#22c55e", dailyCapacity: 1 }
    ],
    monthly_capacity: 22
  },
  "Colorado Springs": {
    crews: [
      { name: "COS Crew", roofers: 2, electricians: 1, color: "#eab308", dailyCapacity: 1 }
    ],
    monthly_capacity: 22
  },
  "San Luis Obispo": {
    crews: [
      { name: "SLO Solar", roofers: 2, electricians: 1, color: "#06b6d4", dailyCapacity: 1 },
      { name: "SLO Electrical 1", roofers: 0, electricians: 2, color: "#a855f7", dailyCapacity: 1 },
      { name: "SLO Electrical 2", roofers: 0, electricians: 2, color: "#14b8a6", dailyCapacity: 1 }
    ],
    monthly_capacity: 66
  },
  "Camarillo": {
    crews: [
      { name: "CAM Crew", roofers: 2, electricians: 1, color: "#f43f5e", dailyCapacity: 1 }
    ],
    monthly_capacity: 22
  }
};

// Global state
let projects = [];
let crews = CREWS_CONFIG;
let capacity_analysis = {};
let summary = { total_projects: 0, total_value: 0, pe_projects: 0, rtb_projects: 0 };

let state = {
  currentView: 'pipeline',
  filters: { location: 'all', pe: 'all', status: 'all', search: '' },
  queueFilter: 'all',
  calendarMonth: new Date().getMonth(),
  calendarYear: new Date().getFullYear(),
  scheduledProjects: {}
};

const today = new Date();
const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
const dayNames = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];

// Helper: Format days display
function formatDays(days, completedDate) {
  if (completedDate) return 'Done';
  if (days === null || days === undefined) return 'N/A';
  if (days === 0) return 'today';
  if (days < 0) return `${Math.abs(days)}d over`;
  return `in ${days}d`;
}

// Transform API data to expected format
function transformProject(p) {
  // Use API's pre-calculated values (which now include default forecast logic)
  const daysToInstall = p.daysToInstall;
  const daysToInspection = p.daysToInspection;
  const daysToPto = p.daysToPto;
  const daysSinceClose = p.daysSinceClose || 0;

  const isRtb = p.stage === 'Ready To Build' || p.stage === 'RTB - Blocked';
  const isSchedulable = isRtb || p.stage === 'Construction';
  const isPE = p.isParticipateEnergy || false;

  let priorityScore = p.priorityScore || 0;

  return {
    id: p.id,
    name: p.name || `Project ${p.id}`,
    pb_location: p.pbLocation || 'Unknown',
    ahj: p.ahj || '',
    utility: p.utility || '',
    stage: p.stage || 'Unknown',
    amount: p.amount || 0,
    url: p.url || `https://app.hubspot.com/contacts/21710069/record/0-3/${p.id}`,
    close_date: p.closeDate,
    forecast_install: p.forecastedInstallDate || p.constructionScheduleDate,
    forecast_inspection: p.forecastedInspectionDate || p.inspectionScheduleDate,
    forecast_pto: p.forecastedPtoDate,
    days_to_install: daysToInstall,
    days_to_inspection: daysToInspection,
    days_to_pto: daysToPto,
    days_since_close: daysSinceClose,
    is_participate_energy: isPE,
    is_rtb: isRtb,
    is_schedulable: isSchedulable,
    priority_score: priorityScore,
    estimated_install_days: p.daysForInstallers || 2,
    default_crew: CREWS_CONFIG[p.pbLocation]?.crews[0]?.name || 'Unassigned',
    // Completion dates for filtering
    construction_complete: p.constructionCompleteDate,
    inspection_pass: p.inspectionPassDate,
    pto_granted: p.ptoGrantedDate
  };
}

function calculateCapacityAnalysis(projectList) {
  const analysis = {};
  Object.keys(CREWS_CONFIG).forEach(location => {
    const config = CREWS_CONFIG[location];
    const locProjects = projectList.filter(p => p.pb_location === location);
    const monthlyForecast = {};
    locProjects.forEach(p => {
      if (p.forecast_install) {
        const month = p.forecast_install.substring(0, 7);
        if (!monthlyForecast[month]) monthlyForecast[month] = { count: 0, days_needed: 0, value: 0 };
        monthlyForecast[month].count++;
        monthlyForecast[month].days_needed += (p.estimated_install_days || 2);
        monthlyForecast[month].value += (p.amount || 0);
      }
    });
    analysis[location] = {
      crews: config.crews,
      monthly_capacity: config.monthly_capacity,
      monthly_forecast: monthlyForecast,
      total_projects: locProjects.length,
      rtb_count: locProjects.filter(p => p.is_rtb).length,
      pe_count: locProjects.filter(p => p.is_participate_energy).length
    };
  });
  return analysis;
}

function calculateSummary(projectList) {
  return {
    total_projects: projectList.length,
    total_value: projectList.reduce((sum, p) => sum + (p.amount || 0), 0),
    pe_projects: projectList.filter(p => p.is_participate_energy).length,
    rtb_projects: projectList.filter(p => p.is_rtb).length,
    schedulable_projects: projectList.filter(p => p.is_schedulable).length
  };
}

async function fetchData() {
  showLoadingState();
  try {
    const response = await fetch('/api/projects?context=executive');
    if (!response.ok) throw new Error('Failed to fetch data');
    const data = await response.json();
    projects = data.projects.map(transformProject);
    capacity_analysis = calculateCapacityAnalysis(projects);
    summary = calculateSummary(projects);
    init();
  } catch (err) {
    console.error('Error fetching data:', err);
    showErrorState(err.message);
  }
}

function showLoadingState() {
  document.getElementById('pipelineStats').innerHTML = `
    <div class="stat-card" style="grid-column: span 6; text-align: center; padding: 2rem;">
      <div style="font-size: 1.2rem; color: var(--text-dim);">Loading live data from HubSpot...</div>
    </div>
  `;
}

function showErrorState(error) {
  document.getElementById('pipelineStats').innerHTML = `
    <div class="stat-card danger" style="grid-column: span 6; text-align: center; padding: 2rem;">
      <div style="font-size: 1.2rem;">Error loading data</div>
      <div style="font-size: 0.8rem; color: var(--text-dim); margin-top: 0.5rem;">${error}</div>
      <button onclick="fetchData()" style="margin-top: 1rem; padding: 8px 16px; background: var(--accent); border: none; border-radius: 6px; cursor: pointer;">Retry</button>
    </div>
  `;
}

function init() {
  document.getElementById('lastUpdated').textContent = 'Updated: ' + new Date().toLocaleString();
  document.getElementById('totalValue').textContent = 'Pipeline: $' + (summary.total_value / 1000000).toFixed(2) + 'M';
  document.getElementById('peCount').textContent = summary.pe_projects;
  renderPipelineView();
  calculateAlerts();
}

function switchView(view) {
  state.currentView = view;
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.querySelector(`.nav-tab[data-view="${view}"]`).classList.add('active');
  document.querySelectorAll('.view-panel').forEach(p => p.classList.remove('active'));
  document.getElementById(view + 'View').classList.add('active');

  if (view === 'pipeline') renderPipelineView();
  else if (view === 'revenue') renderRevenueView();
  else if (view === 'capacity') renderCapacityView();
  else if (view === 'scheduler') renderSchedulerView();
  else if (view === 'pe') renderPEView();
  else if (view === 'alerts') renderAlertsView();
}

function renderPipelineView() {
  const overdueInstall = projects.filter(p => p.days_to_install !== null && p.days_to_install < 0 && !p.construction_complete).length;
  const overdueInspection = projects.filter(p => p.days_to_inspection !== null && p.days_to_inspection < 0 && !p.inspection_pass).length;
  const overduePto = projects.filter(p => p.days_to_pto !== null && p.days_to_pto < 0 && !p.pto_granted).length;
  const rtbCount = projects.filter(p => p.is_rtb).length;
  const peCount = projects.filter(p => p.is_participate_energy).length;

  document.getElementById('pipelineStats').innerHTML = `
    <div class="stat-card">
      <div class="stat-value">${summary.total_projects}</div>
      <div class="stat-label">Total Projects</div>
      <div class="stat-sub">$${(summary.total_value/1000000).toFixed(1)}M pipeline</div>
    </div>
    <div class="stat-card accent">
      <div class="stat-value">${rtbCount}</div>
      <div class="stat-label">Ready to Build</div>
      <div class="stat-sub">Available to schedule</div>
    </div>
    <div class="stat-card pe">
      <div class="stat-value">${peCount}</div>
      <div class="stat-label">Participate Energy</div>
      <div class="stat-sub">Milestone tracking</div>
    </div>
    <div class="stat-card danger">
      <div class="stat-value">${overdueInstall}</div>
      <div class="stat-label">Install Overdue</div>
      <div class="stat-sub">Past forecast date</div>
    </div>
    <div class="stat-card" style="border-color: var(--warning);">
      <div class="stat-value">${overdueInspection}</div>
      <div class="stat-label">Inspection Overdue</div>
    </div>
    <div class="stat-card" style="border-color: var(--purple);">
      <div class="stat-value">${overduePto}</div>
      <div class="stat-label">PTO Overdue</div>
    </div>
  `;

  const locations = [...new Set(projects.map(p => p.pb_location))].filter(l => l !== 'Unknown').sort();
  document.getElementById('pipelineFilters').innerHTML = `
    <div class="filter-group">
      <span class="filter-label">Location:</span>
      <select class="filter-select" onchange="updateFilter('location', this.value)">
        <option value="all">All Locations</option>
        ${locations.map(l => `<option value="${l}">${l}</option>`).join('')}
      </select>
    </div>
    <div class="filter-group">
      <span class="filter-label">Type:</span>
      <button class="filter-btn ${state.filters.pe === 'all' ? 'active' : ''}" onclick="updateFilter('pe', 'all')">All</button>
      <button class="filter-btn pe-filter ${state.filters.pe === 'pe' ? 'active' : ''}" onclick="updateFilter('pe', 'pe')">PE Only</button>
      <button class="filter-btn ${state.filters.pe === 'non-pe' ? 'active' : ''}" onclick="updateFilter('pe', 'non-pe')">Non-PE</button>
    </div>
    <div class="filter-group">
      <span class="filter-label">Status:</span>
      <button class="filter-btn ${state.filters.status === 'all' ? 'active' : ''}" onclick="updateFilter('status', 'all')">All</button>
      <button class="filter-btn ${state.filters.status === 'overdue' ? 'active' : ''}" onclick="updateFilter('status', 'overdue')">Overdue</button>
      <button class="filter-btn ${state.filters.status === 'rtb' ? 'active' : ''}" onclick="updateFilter('status', 'rtb')">RTB</button>
    </div>
    <div class="filter-group" style="flex: 1;">
      <input class="filter-input" type="text" placeholder="Search projects..." style="width: 200px;" oninput="updateFilter('search', this.value)">
    </div>
  `;
  renderPipelineTable();
}

function renderPipelineTable() {
  let filtered = [...projects];
  if (state.filters.location !== 'all') filtered = filtered.filter(p => p.pb_location === state.filters.location);
  if (state.filters.pe === 'pe') filtered = filtered.filter(p => p.is_participate_energy);
  else if (state.filters.pe === 'non-pe') filtered = filtered.filter(p => !p.is_participate_energy);
  if (state.filters.status === 'overdue') filtered = filtered.filter(p => (p.days_to_install !== null && p.days_to_install < 0 && !p.construction_complete) || (p.days_to_pto !== null && p.days_to_pto < 0 && !p.pto_granted));
  else if (state.filters.status === 'rtb') filtered = filtered.filter(p => p.is_rtb);
  if (state.filters.search) {
    const s = state.filters.search.toLowerCase();
    filtered = filtered.filter(p => p.name.toLowerCase().includes(s) || (p.ahj || '').toLowerCase().includes(s));
  }
  filtered.sort((a, b) => b.priority_score - a.priority_score);

  document.getElementById('pipelineTable').innerHTML = filtered.slice(0, 100).map((p, i) => {
    const peClass = p.is_participate_energy ? 'pe-row' : '';
    const overdueClass = (p.days_to_install !== null && p.days_to_install < 0 && !p.construction_complete) ? 'overdue' : '';
    const priorityPct = Math.min(100, (p.priority_score / 150) * 100);
    const priorityColor = p.priority_score > 100 ? 'var(--danger)' : p.priority_score > 50 ? 'var(--warning)' : 'var(--rtb)';
    return `
      <div class="table-row ${peClass} ${overdueClass}">
        <div>${i + 1}</div>
        <div>
          <div style="display: flex; align-items: center; gap: 6px;">
            ${p.is_participate_energy ? '<span class="badge badge-pe">PE</span>' : ''}
            ${p.is_rtb ? '<span class="badge badge-rtb">RTB</span>' : ''}
            <a href="${p.url}" target="_blank" style="font-weight: 600;">${p.name.split('|')[0].trim()}</a>
          </div>
          <div style="font-size: 0.65rem; color: var(--text-dim);">${p.stage}</div>
        </div>
        <div>
          <div>${p.pb_location}</div>
          <div style="font-size: 0.65rem; color: var(--text-dim);">${p.ahj || '-'}</div>
        </div>
        <div style="font-family: 'JetBrains Mono', monospace; font-weight: 600; color: var(--accent);">$${((p.amount || 0)/1000).toFixed(0)}k</div>
        <div class="days-indicator ${p.construction_complete ? 'ok' : p.days_to_install !== null && p.days_to_install < 0 ? 'overdue' : p.days_to_install !== null && p.days_to_install <= 14 ? 'warning' : 'ok'}">${formatDays(p.days_to_install, p.construction_complete)}</div>
        <div class="days-indicator ${p.inspection_pass ? 'ok' : p.days_to_inspection !== null && p.days_to_inspection < 0 ? 'overdue' : p.days_to_inspection !== null && p.days_to_inspection <= 14 ? 'warning' : 'ok'}">${formatDays(p.days_to_inspection, p.inspection_pass)}</div>
        <div class="days-indicator ${p.pto_granted ? 'ok' : p.days_to_pto !== null && p.days_to_pto < 0 ? 'overdue' : p.days_to_pto !== null && p.days_to_pto <= 30 ? 'warning' : 'ok'}">${formatDays(p.days_to_pto, p.pto_granted)}</div>
        <div>
          <div class="priority-bar"><div class="priority-fill" style="width: ${priorityPct}%; background: ${priorityColor};"></div></div>
          <div style="font-size: 0.6rem; color: var(--text-dim); margin-top: 2px;">${p.priority_score.toFixed(0)}</div>
        </div>
        <div>
          ${p.is_schedulable ? `<button class="filter-btn" onclick="scheduleProject('${p.id}')" style="font-size: 0.65rem; padding: 4px 8px;">Schedule</button>` : ''}
        </div>
      </div>
    `;
  }).join('');
}

function updateFilter(key, value) {
  state.filters[key] = value;
  renderPipelineView();
}

// Revenue view state
let revenueViewMode = 'weekly';

function setRevenueView(mode) {
  revenueViewMode = mode;
  document.getElementById('weeklyBtn').classList.toggle('active', mode === 'weekly');
  document.getElementById('monthlyBtn').classList.toggle('active', mode === 'monthly');
  renderRevenueTimeline();
}

function renderRevenueView() {
  const totalValue = projects.reduce((sum, p) => sum + (p.amount || 0), 0);
  const scheduledValue = projects.filter(p => p.forecast_install).reduce((sum, p) => sum + (p.amount || 0), 0);
  const rtbValue = projects.filter(p => p.is_rtb).reduce((sum, p) => sum + (p.amount || 0), 0);
  const peValue = projects.filter(p => p.is_participate_energy).reduce((sum, p) => sum + (p.amount || 0), 0);

  document.getElementById('revenueStats').innerHTML = `
    <div class="stat-card">
      <div class="stat-value">$${(totalValue/1000000).toFixed(2)}M</div>
      <div class="stat-label">Total Pipeline</div>
      <div class="stat-sub">${projects.length} projects</div>
    </div>
    <div class="stat-card accent">
      <div class="stat-value">$${(scheduledValue/1000000).toFixed(2)}M</div>
      <div class="stat-label">Scheduled</div>
      <div class="stat-sub">With install dates</div>
    </div>
    <div class="stat-card" style="border-color: var(--rtb);">
      <div class="stat-value">$${(rtbValue/1000000).toFixed(2)}M</div>
      <div class="stat-label">Ready to Build</div>
      <div class="stat-sub">${projects.filter(p => p.is_rtb).length} projects</div>
    </div>
    <div class="stat-card pe">
      <div class="stat-value">$${(peValue/1000000).toFixed(2)}M</div>
      <div class="stat-label">Participate Energy</div>
      <div class="stat-sub">${projects.filter(p => p.is_participate_energy).length} projects</div>
    </div>
  `;

  renderStageRevenueTable();
  renderLocationRevenueTable();
  renderRevenueTimeline();
}

function renderStageRevenueTable() {
  // Define stage order for display
  const stageOrder = [
    'Site Survey', 'Design & Engineering', 'Permitting & Interconnection',
    'RTB - Blocked', 'Ready To Build', 'Construction', 'Inspection',
    'Permission To Operate', 'Close Out'
  ];

  // Calculate revenue by stage
  const stageData = {};
  let maxValue = 0;
  projects.forEach(p => {
    const stage = p.stage;
    if (!stageData[stage]) stageData[stage] = { count: 0, value: 0 };
    stageData[stage].count++;
    stageData[stage].value += (p.amount || 0);
    if (stageData[stage].value > maxValue) maxValue = stageData[stage].value;
  });

  // Sort by stage order
  const sortedStages = Object.keys(stageData).sort((a, b) => {
    const aIdx = stageOrder.indexOf(a);
    const bIdx = stageOrder.indexOf(b);
    if (aIdx === -1 && bIdx === -1) return a.localeCompare(b);
    if (aIdx === -1) return 1;
    if (bIdx === -1) return -1;
    return aIdx - bIdx;
  });

  const totalValue = projects.reduce((sum, p) => sum + (p.amount || 0), 0);
  const totalCount = projects.length;

  // Color mapping for stages
  const stageColors = {
    'Site Survey': '#3b82f6',
    'Design & Engineering': '#8b5cf6',
    'Permitting & Interconnection': '#ec4899',
    'RTB - Blocked': '#ef4444',
    'Ready To Build': '#10b981',
    'Construction': '#f97316',
    'Inspection': '#eab308',
    'Permission To Operate': '#06b6d4',
    'Close Out': '#22c55e'
  };

  document.getElementById('stageRevenueTable').innerHTML = `
    <div class="revenue-table">
      <div class="revenue-row header">
        <div>Stage</div>
        <div style="text-align: right;">Projects</div>
        <div style="text-align: right;">Value</div>
        <div>Distribution</div>
      </div>
      ${sortedStages.map(stage => {
        const data = stageData[stage];
        const pct = maxValue > 0 ? (data.value / maxValue * 100) : 0;
        const color = stageColors[stage] || 'var(--accent)';
        return `
          <div class="revenue-row">
            <div class="revenue-stage">${stage}</div>
            <div style="text-align: right;" class="revenue-count">${data.count}</div>
            <div style="text-align: right;" class="revenue-amount">$${(data.value/1000).toFixed(0)}k</div>
            <div>
              <div class="revenue-bar">
                <div class="revenue-bar-fill" style="width: ${pct}%; background: ${color};"></div>
              </div>
            </div>
          </div>
        `;
      }).join('')}
      <div class="revenue-row total">
        <div>Total</div>
        <div style="text-align: right;">${totalCount}</div>
        <div style="text-align: right;" class="revenue-amount">$${(totalValue/1000000).toFixed(2)}M</div>
        <div></div>
      </div>
    </div>
  `;
}

function renderLocationRevenueTable() {
  // Calculate revenue by location
  const locationData = {};
  projects.forEach(p => {
    const loc = p.pb_location || 'Unknown';
    if (!locationData[loc]) locationData[loc] = { count: 0, value: 0, rtbValue: 0, scheduledValue: 0 };
    locationData[loc].count++;
    locationData[loc].value += (p.amount || 0);
    if (p.is_rtb) locationData[loc].rtbValue += (p.amount || 0);
    if (p.forecast_install) locationData[loc].scheduledValue += (p.amount || 0);
  });

  const sortedLocations = Object.keys(locationData).sort((a, b) => locationData[b].value - locationData[a].value);

  document.getElementById('locationRevenueTable').innerHTML = `
    <div style="font-size: 0.85rem;">
      <div class="location-revenue-row" style="font-weight: 600; font-size: 0.7rem; color: var(--text-dim); text-transform: uppercase;">
        <div>Location</div>
        <div style="text-align: right;">Projects</div>
        <div style="text-align: right;">Total</div>
        <div style="text-align: right;">RTB</div>
        <div style="text-align: right;">Scheduled</div>
      </div>
      ${sortedLocations.map(loc => {
        const data = locationData[loc];
        return `
          <div class="location-revenue-row">
            <div style="font-weight: 500;">${loc}</div>
            <div style="text-align: right; color: var(--text-dim);">${data.count}</div>
            <div style="text-align: right; font-family: 'JetBrains Mono', monospace; color: var(--accent);">$${(data.value/1000).toFixed(0)}k</div>
            <div style="text-align: right; font-family: 'JetBrains Mono', monospace; color: var(--rtb);">$${(data.rtbValue/1000).toFixed(0)}k</div>
            <div style="text-align: right; font-family: 'JetBrains Mono', monospace; color: var(--info);">$${(data.scheduledValue/1000).toFixed(0)}k</div>
          </div>
        `;
      }).join('')}
    </div>
  `;
}

function renderRevenueTimeline() {
  const now = new Date();
  const periods = [];

  if (revenueViewMode === 'weekly') {
    // Generate next 8 weeks
    for (let i = 0; i < 8; i++) {
      const weekStart = new Date(now);
      weekStart.setDate(weekStart.getDate() - weekStart.getDay() + (i * 7)); // Start of week (Sunday)
      const weekEnd = new Date(weekStart);
      weekEnd.setDate(weekEnd.getDate() + 6);

      periods.push({
        label: weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' - ' + weekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
        start: weekStart,
        end: weekEnd
      });
    }
  } else {
    // Generate next 6 months
    for (let i = 0; i < 6; i++) {
      const monthStart = new Date(now.getFullYear(), now.getMonth() + i, 1);
      const monthEnd = new Date(now.getFullYear(), now.getMonth() + i + 1, 0);

      periods.push({
        label: monthStart.toLocaleDateString('en-US', { month: 'short', year: '2-digit' }),
        start: monthStart,
        end: monthEnd
      });
    }
  }

  // Calculate revenue per period by location
  const locations = [...new Set(projects.map(p => p.pb_location))].filter(l => l !== 'Unknown').sort();
  const periodData = periods.map(period => {
    const data = { label: period.label, total: 0, count: 0, byLocation: {} };
    locations.forEach(loc => data.byLocation[loc] = { value: 0, count: 0 });

    projects.forEach(p => {
      if (p.forecast_install) {
        const installDate = new Date(p.forecast_install);
        if (installDate >= period.start && installDate <= period.end) {
          data.total += (p.amount || 0);
          data.count++;
          if (data.byLocation[p.pb_location]) {
            data.byLocation[p.pb_location].value += (p.amount || 0);
            data.byLocation[p.pb_location].count++;
          }
        }
      }
    });
    return data;
  });

  document.getElementById('revenueTimeline').innerHTML = `
    <div style="font-size: 0.85rem; max-height: 400px; overflow-y: auto;">
      <div class="timeline-row header">
        <div>Period</div>
        <div style="text-align: right;">Projects</div>
        <div style="text-align: right;">Revenue</div>
        <div>Details</div>
      </div>
      ${periodData.map(period => {
        const locationBreakdown = Object.entries(period.byLocation)
          .filter(([_, d]) => d.count > 0)
          .map(([loc, d]) => `${loc}: $${(d.value/1000).toFixed(0)}k (${d.count})`)
          .join(', ');

        return `
          <div class="timeline-row">
            <div style="font-weight: 500;">${period.label}</div>
            <div style="text-align: right; color: var(--text-dim);">${period.count}</div>
            <div style="text-align: right; font-family: 'JetBrains Mono', monospace; color: var(--accent);">$${(period.total/1000).toFixed(0)}k</div>
            <div>
              <button class="filter-btn" style="font-size: 0.6rem; padding: 2px 6px;" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'">+</button>
              <div style="display: none; font-size: 0.7rem; color: var(--text-dim); margin-top: 4px;">${locationBreakdown || 'No scheduled installs'}</div>
            </div>
          </div>
        `;
      }).join('')}
      <div class="timeline-row" style="font-weight: 700; background: var(--bg); border-radius: 8px; margin-top: 8px;">
        <div>Total</div>
        <div style="text-align: right;">${periodData.reduce((s, p) => s + p.count, 0)}</div>
        <div style="text-align: right; font-family: 'JetBrains Mono', monospace; color: var(--accent);">$${(periodData.reduce((s, p) => s + p.total, 0)/1000000).toFixed(2)}M</div>
        <div></div>
      </div>
    </div>
  `;
}

function renderCapacityView() {
  const locations = Object.keys(capacity_analysis);
  document.getElementById('capacityGrid').innerHTML = locations.map(loc => {
    const cap = capacity_analysis[loc];
    const monthKeys = Object.keys(cap.monthly_forecast).sort().slice(0, 6);
    return `
      <div class="capacity-card">
        <div class="capacity-header">
          <div class="capacity-title">${loc}</div>
          <div class="capacity-crews">${cap.crews.length} crew(s) - ${cap.monthly_capacity} days/mo</div>
        </div>
        <div class="capacity-chart"><canvas id="chart-${loc.replace(/\s/g, '')}"></canvas></div>
        <div class="capacity-stats">
          <div class="cap-stat"><div class="cap-stat-value">${cap.total_projects}</div><div class="cap-stat-label">Projects</div></div>
          <div class="cap-stat"><div class="cap-stat-value" style="color: var(--rtb);">${cap.rtb_count}</div><div class="cap-stat-label">RTB</div></div>
          <div class="cap-stat"><div class="cap-stat-value" style="color: var(--pe-green);">${cap.pe_count}</div><div class="cap-stat-label">PE Projects</div></div>
        </div>
      </div>
    `;
  }).join('');

  setTimeout(() => {
    locations.forEach(loc => {
      const cap = capacity_analysis[loc];
      const monthKeys = Object.keys(cap.monthly_forecast).sort().slice(0, 6);
      const ctx = document.getElementById('chart-' + loc.replace(/\s/g, ''));
      if (!ctx) return;
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: monthKeys.map(k => k.substring(5)),
          datasets: [
            { label: 'Forecasted Days', data: monthKeys.map(k => cap.monthly_forecast[k]?.days_needed || 0), backgroundColor: 'rgba(59, 130, 246, 0.7)' },
            { label: 'Capacity', data: monthKeys.map(() => cap.monthly_capacity), type: 'line', borderColor: '#10b981', borderWidth: 2, fill: false, pointRadius: 0 }
          ]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: { display: true, position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } } },
          scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' } }, x: { grid: { display: false } } }
        }
      });
    });
  }, 100);
}

function runCapacityOptimization() {
  let totalGap = 0, overCapacity = 0, underCapacity = 0;
  Object.values(capacity_analysis).forEach(cap => {
    Object.values(cap.monthly_forecast).forEach(m => {
      const gap = m.days_needed - cap.monthly_capacity;
      if (gap > 0) { totalGap += gap; overCapacity++; } else { underCapacity++; }
    });
  });
  document.getElementById('capacityOptStats').innerHTML = `
    <div class="opt-stat"><div class="opt-stat-value" style="color: var(--danger);">${totalGap}</div><div class="opt-stat-label">Days Over Capacity</div></div>
    <div class="opt-stat"><div class="opt-stat-value" style="color: var(--warning);">${overCapacity}</div><div class="opt-stat-label">Months Overloaded</div></div>
    <div class="opt-stat"><div class="opt-stat-value" style="color: var(--rtb);">${underCapacity}</div><div class="opt-stat-label">Months OK</div></div>
    <div class="opt-stat"><div class="opt-stat-value">${Object.keys(crews).length}</div><div class="opt-stat-label">Locations</div></div>
  `;
}

function renderSchedulerView() { renderQueue(); renderCalendar(); }

function renderQueue() {
  let queueProjects = projects.filter(p => p.is_schedulable);
  if (state.queueFilter === 'rtb') queueProjects = queueProjects.filter(p => p.is_rtb);
  else if (state.queueFilter === 'pe') queueProjects = queueProjects.filter(p => p.is_participate_energy);
  else if (state.queueFilter === 'priority') queueProjects = queueProjects.filter(p => p.priority_score > 50);
  queueProjects.sort((a, b) => b.priority_score - a.priority_score);

  document.getElementById('queueCount').textContent = `${queueProjects.length} projects - $${(queueProjects.reduce((s,p) => s + (p.amount||0), 0)/1000).toFixed(0)}K`;
  document.getElementById('queueList').innerHTML = queueProjects.slice(0, 30).map(p => `
    <div class="queue-item ${p.is_participate_energy ? 'pe' : ''}" draggable="true" ondragstart="dragProject(event, '${p.id}')">
      <div class="queue-item-header">
        <div class="queue-item-name">${p.name.split('|')[1]?.trim() || p.name.split('|')[0].trim()}</div>
        <div class="queue-item-amount">$${((p.amount||0)/1000).toFixed(0)}k</div>
      </div>
      <div class="queue-item-meta">${p.pb_location} - ${p.ahj || '-'}</div>
      <div class="queue-item-tags">
        ${p.is_participate_energy ? '<span class="queue-item-tag" style="background: var(--pe-dim); color: var(--pe-green);">PE</span>' : ''}
        ${p.is_rtb ? '<span class="queue-item-tag" style="background: rgba(16,185,129,0.2); color: var(--rtb);">RTB</span>' : ''}
        <span class="queue-item-tag">Install: ${formatDays(p.days_to_install, p.construction_complete)}</span>
        <span class="queue-item-tag">Priority: ${p.priority_score.toFixed(0)}</span>
      </div>
    </div>
  `).join('');
}

function filterQueue(filter) {
  state.queueFilter = filter;
  document.querySelectorAll('.queue-tab').forEach(t => t.classList.remove('active'));
  document.querySelector(`.queue-tab[data-filter="${filter}"]`).classList.add('active');
  renderQueue();
}

function renderCalendar() {
  const year = state.calendarYear, month = state.calendarMonth;
  const firstDay = new Date(year, month, 1), lastDay = new Date(year, month + 1, 0);
  const startDay = firstDay.getDay(), daysInMonth = lastDay.getDate();

  document.getElementById('calendarTitle').textContent = `${monthNames[month]} ${year}`;
  let html = dayNames.map(d => `<div class="calendar-day-header">${d}</div>`).join('');

  const prevMonth = new Date(year, month, 0);
  for (let i = startDay - 1; i >= 0; i--) html += `<div class="calendar-day other-month"><div class="calendar-day-num">${prevMonth.getDate() - i}</div></div>`;

  for (let d = 1; d <= daysInMonth; d++) {
    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const isToday = today.getFullYear() === year && today.getMonth() === month && today.getDate() === d;
    const dayProjects = projects.filter(p => p.forecast_install === dateStr);
    html += `<div class="calendar-day ${isToday ? 'today' : ''}" ondrop="dropProject(event, '${dateStr}')" ondragover="event.preventDefault()">
      <div class="calendar-day-num">${d}</div>
      ${dayProjects.slice(0, 3).map(p => `<div class="calendar-event ${p.is_participate_energy ? 'pe' : 'regular'}" title="${p.name}">${p.name.split('|')[1]?.split(',')[0]?.trim() || p.name.split('|')[0].trim()}</div>`).join('')}
      ${dayProjects.length > 3 ? `<div style="font-size: 0.5rem; color: var(--text-dim);">+${dayProjects.length - 3} more</div>` : ''}
    </div>`;
  }

  const remaining = 42 - (startDay + daysInMonth);
  for (let i = 1; i <= remaining; i++) html += `<div class="calendar-day other-month"><div class="calendar-day-num">${i}</div></div>`;
  document.getElementById('calendarGrid').innerHTML = html;
}

function prevMonth() { state.calendarMonth--; if (state.calendarMonth < 0) { state.calendarMonth = 11; state.calendarYear--; } renderCalendar(); }
function nextMonth() { state.calendarMonth++; if (state.calendarMonth > 11) { state.calendarMonth = 0; state.calendarYear++; } renderCalendar(); }
function dragProject(e, id) { e.dataTransfer.setData('projectId', id); }
function dropProject(e, date) {
  e.preventDefault();
  const id = e.dataTransfer.getData('projectId');
  const project = projects.find(p => p.id == id);
  if (project) {
    state.scheduledProjects[id] = { date, crew: project.default_crew };
    project.forecast_install = date;
    renderCalendar(); renderQueue();
    alert(`Scheduled ${project.name.split('|')[1]?.trim() || project.name} for ${date}`);
  }
}

function renderPEView() {
  const peProjects = projects.filter(p => p.is_participate_energy);
  const overdueInsp = peProjects.filter(p => p.days_to_inspection !== null && p.days_to_inspection < 0 && !p.inspection_pass).length;
  const overduePto = peProjects.filter(p => p.days_to_pto !== null && p.days_to_pto < 0 && !p.pto_granted).length;
  const soonInsp = peProjects.filter(p => !p.inspection_pass && p.days_to_inspection !== null && p.days_to_inspection >= 0 && p.days_to_inspection <= 14).length;
  const soonPto = peProjects.filter(p => !p.pto_granted && p.days_to_pto !== null && p.days_to_pto >= 0 && p.days_to_pto <= 30).length;
  const totalValue = peProjects.reduce((s, p) => s + (p.amount || 0), 0);

  document.getElementById('peStats').innerHTML = `
    <div class="stat-card pe"><div class="stat-value">${peProjects.length}</div><div class="stat-label">PE Projects</div><div class="stat-sub">$${(totalValue/1000000).toFixed(2)}M value</div></div>
    <div class="stat-card danger"><div class="stat-value">${overdueInsp}</div><div class="stat-label">Inspection Overdue</div></div>
    <div class="stat-card" style="border-color: var(--warning);"><div class="stat-value">${soonInsp}</div><div class="stat-label">Inspection in 14d</div></div>
    <div class="stat-card danger"><div class="stat-value">${overduePto}</div><div class="stat-label">PTO Overdue</div></div>
    <div class="stat-card" style="border-color: var(--warning);"><div class="stat-value">${soonPto}</div><div class="stat-label">PTO in 30d</div></div>
  `;

  // Filter out completed inspections and sort by days
  const inspProjects = peProjects.filter(p => !p.inspection_pass && p.days_to_inspection !== null && p.days_to_inspection <= 30).sort((a,b) => a.days_to_inspection - b.days_to_inspection);
  document.getElementById('peInspectionList').innerHTML = inspProjects.slice(0, 15).map(p => `
    <div class="pe-milestone-item">
      <div><div style="font-weight: 600; font-size: 0.8rem;">${p.name.split('|')[1]?.trim() || p.name}</div><div style="font-size: 0.65rem; color: var(--text-dim);">${p.pb_location} - ${p.forecast_inspection || 'No date'}</div></div>
      <div class="days-indicator ${p.days_to_inspection < 0 ? 'overdue' : p.days_to_inspection <= 14 ? 'warning' : 'ok'}">${formatDays(p.days_to_inspection)}</div>
    </div>
  `).join('') || '<div style="color: var(--text-dim); font-size: 0.75rem;">No upcoming inspections</div>';

  // Filter out completed PTO and sort by days
  const ptoProjects = peProjects.filter(p => !p.pto_granted && p.days_to_pto !== null && p.days_to_pto <= 45).sort((a,b) => a.days_to_pto - b.days_to_pto);
  document.getElementById('pePtoList').innerHTML = ptoProjects.slice(0, 15).map(p => `
    <div class="pe-milestone-item">
      <div><div style="font-weight: 600; font-size: 0.8rem;">${p.name.split('|')[1]?.trim() || p.name}</div><div style="font-size: 0.65rem; color: var(--text-dim);">${p.pb_location} - ${p.forecast_pto || 'No date'}</div></div>
      <div class="days-indicator ${p.days_to_pto < 0 ? 'overdue' : p.days_to_pto <= 30 ? 'warning' : 'ok'}">${formatDays(p.days_to_pto)}</div>
    </div>
  `).join('') || '<div style="color: var(--text-dim); font-size: 0.75rem;">No upcoming PTO</div>';
}

function exportPEReport(format) {
  const peProjects = projects.filter(p => p.is_participate_energy);
  if (format === 'clipboard') {
    const headers = ['Project ID', 'Name', 'Location', 'Forecast Install', 'Forecast Inspection', 'Forecast PTO', 'Days to PTO'];
    const rows = peProjects.map(p => [p.id, p.name, p.pb_location, p.forecast_install, p.forecast_inspection, p.forecast_pto, p.days_to_pto].join('\t'));
    navigator.clipboard.writeText(headers.join('\t') + '\n' + rows.join('\n'));
    alert('Copied ' + peProjects.length + ' PE projects to clipboard!');
  } else {
    alert('Excel/CSV export: Use the dedicated PE dashboard for full export functionality');
  }
}

function calculateAlerts() {
  const alerts = [];
  // Only alert for projects that are significantly overdue AND not yet complete
  projects.filter(p => p.days_to_install !== null && p.days_to_install < -7 && !p.construction_complete).forEach(p => {
    alerts.push({ type: 'danger', title: 'Install Significantly Overdue', message: `${p.name.split('|')[1]?.trim() || p.name} is ${Math.abs(p.days_to_install)} days past forecast`, project: p });
  });
  projects.filter(p => p.is_participate_energy && p.days_to_pto !== null && p.days_to_pto < 0 && !p.pto_granted).forEach(p => {
    alerts.push({ type: 'danger', title: 'PE PTO Overdue', message: `${p.name.split('|')[1]?.trim() || p.name} PE milestone at risk`, project: p });
  });
  Object.entries(capacity_analysis).forEach(([loc, cap]) => {
    Object.entries(cap.monthly_forecast).forEach(([month, data]) => {
      if (data.days_needed > cap.monthly_capacity * 1.2) {
        alerts.push({ type: 'warning', title: 'Capacity Overload', message: `${loc} forecasted ${data.days_needed} days in ${month}, capacity is ${cap.monthly_capacity}` });
      }
    });
  });
  document.getElementById('alertCount').textContent = alerts.filter(a => a.type === 'danger').length;
  window.alerts = alerts;
}

function renderAlertsView() {
  const alerts = window.alerts || [];
  const dangerCount = alerts.filter(a => a.type === 'danger').length;
  const warningCount = alerts.filter(a => a.type === 'warning').length;

  document.getElementById('alertStats').innerHTML = `
    <div class="stat-card danger"><div class="stat-value">${dangerCount}</div><div class="stat-label">Critical Alerts</div></div>
    <div class="stat-card" style="border-color: var(--warning);"><div class="stat-value">${warningCount}</div><div class="stat-label">Warnings</div></div>
    <div class="stat-card"><div class="stat-value">${alerts.length}</div><div class="stat-label">Total Alerts</div></div>
    <div class="stat-card pe"><div class="stat-value">${alerts.filter(a => a.title.includes('PE')).length}</div><div class="stat-label">PE Related</div></div>
  `;

  document.getElementById('alertsList').innerHTML = `
    <div style="display: grid; gap: 1rem; margin-top: 1rem;">
      ${alerts.slice(0, 20).map(a => `
        <div style="background: var(--surface); border: 1px solid ${a.type === 'danger' ? 'var(--danger)' : 'var(--warning)'}; border-radius: 8px; padding: 1rem;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 0.5rem;">
            <span style="color: ${a.type === 'danger' ? 'var(--danger)' : 'var(--warning)'}; font-size: 1.2rem;">${a.type === 'danger' ? 'X' : '!'}</span>
            <span style="font-weight: 600;">${a.title}</span>
          </div>
          <div style="font-size: 0.8rem; color: var(--text-dim);">${a.message}</div>
          ${a.project ? `<a href="${a.project.url}" target="_blank" style="font-size: 0.7rem; margin-top: 0.5rem; display: inline-block;">View in HubSpot</a>` : ''}
        </div>
      `).join('')}
    </div>
  `;
}

// Start loading data
fetchData();
// Refresh every 5 minutes
setInterval(fetchData, 5 * 60 * 1000);
</script>
</body>
</html>
