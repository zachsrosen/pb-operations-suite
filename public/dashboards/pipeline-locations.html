<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="PB Pipeline Location Comparison - Regional performance metrics and analysis">
    <meta name="theme-color" content="#0f172a">
    <title>Location Comparison | Photon Brothers</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }</style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
const { useState, useMemo, useEffect, useRef } = React;

function transformProject(p) {
    const now = new Date();
    const closeDate = p.closeDate ? new Date(p.closeDate) : null;
    const daysSinceClose = closeDate ? Math.floor((now - closeDate) / (1000 * 60 * 60 * 24)) : 0;

    const forecastInstall = p.installScheduleDate || (closeDate ? new Date(closeDate.getTime() + 75*24*60*60*1000).toISOString().split('T')[0] : null);
    const forecastInspection = p.inspectionCompletionDate || (closeDate ? new Date(closeDate.getTime() + 114*24*60*60*1000).toISOString().split('T')[0] : null);
    const forecastPto = p.ptoCompletionDate || (closeDate ? new Date(closeDate.getTime() + 139*24*60*60*1000).toISOString().split('T')[0] : null);

    const daysToInstall = forecastInstall ? Math.floor((new Date(forecastInstall) - now) / (1000 * 60 * 60 * 24)) : null;
    const daysToInspection = forecastInspection ? Math.floor((new Date(forecastInspection) - now) / (1000 * 60 * 60 * 24)) : null;
    const daysToPto = forecastPto ? Math.floor((new Date(forecastPto) - now) / (1000 * 60 * 60 * 24)) : null;

    return {
        id: p.id,
        name: p.name,
        pb_location: p.pbLocation || 'Unknown',
        ahj: p.ahj || 'Unknown',
        utility: p.utility || 'Unknown',
        project_type: p.projectType || 'Unknown',
        stage: p.stage,
        amount: p.amount || 0,
        url: p.url,
        close_date: p.closeDate,
        forecast_install: forecastInstall,
        forecast_inspection: forecastInspection,
        forecast_pto: forecastPto,
        days_to_install: daysToInstall,
        days_to_inspection: daysToInspection,
        days_to_pto: daysToPto,
        days_since_close: daysSinceClose
    };
}

function LocationDashboard() {
    const [projects, setProjects] = useState([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);
    const [lastUpdated, setLastUpdated] = useState(null);
    const [selectedLocation, setSelectedLocation] = useState(null);
    const [metric, setMetric] = useState('count');
    const chartRef = useRef(null);
    const chartInstance = useRef(null);

    const today = new Date();

    useEffect(() => {
        async function fetchData() {
            try {
                setLoading(true);
                const response = await fetch('/api/projects?context=executive');
                if (!response.ok) throw new Error('Failed to fetch data');
                const data = await response.json();
                setProjects(data.projects.map(transformProject));
                setLastUpdated(new Date().toLocaleTimeString());
                setError(null);
            } catch (err) {
                setError(err.message);
            } finally {
                setLoading(false);
            }
        }

        fetchData();
        const interval = setInterval(fetchData, 5 * 60 * 1000);
        return () => clearInterval(interval);
    }, []);

    const locationColors = {
        'Westminster': { bg: '#3B82F6', light: '#DBEAFE' },
        'Centennial': { bg: '#10B981', light: '#D1FAE5' },
        'Colorado Springs': { bg: '#F59E0B', light: '#FEF3C7' },
        'San Luis Obispo': { bg: '#8B5CF6', light: '#EDE9FE' },
        'Camarillo': { bg: '#EC4899', light: '#FCE7F3' },
        'Unknown': { bg: '#6B7280', light: '#F3F4F6' }
    };

    // Calculate stats per location
    const locationStats = useMemo(() => {
        const stats = {};

        projects.forEach(p => {
            const loc = p.pb_location || 'Unknown';
            if (!stats[loc]) {
                stats[loc] = {
                    name: loc,
                    count: 0,
                    totalValue: 0,
                    avgDaysToInstall: [],
                    avgDaysToInspection: [],
                    avgDaysToPTO: [],
                    overdue: 0,
                    thisMonth: 0,
                    nextMonth: 0,
                    stages: {},
                    projects: []
                };
            }

            const s = stats[loc];
            s.count++;
            s.totalValue += (p.amount || 0);
            s.projects.push(p);

            if (p.days_to_install !== null) s.avgDaysToInstall.push(p.days_to_install);
            if (p.days_to_inspection !== null) s.avgDaysToInspection.push(p.days_to_inspection);
            if (p.days_to_pto !== null) s.avgDaysToPTO.push(p.days_to_pto);

            // Check if overdue
            if (p.forecast_pto && new Date(p.forecast_pto) < today) s.overdue++;

            // Check PTO timing
            if (p.forecast_pto) {
                const ptoDate = new Date(p.forecast_pto);
                if (ptoDate.getMonth() === today.getMonth() && ptoDate.getFullYear() === today.getFullYear()) {
                    s.thisMonth++;
                }
                const nextMonth = new Date(today);
                nextMonth.setMonth(nextMonth.getMonth() + 1);
                if (ptoDate.getMonth() === nextMonth.getMonth() && ptoDate.getFullYear() === nextMonth.getFullYear()) {
                    s.nextMonth++;
                }
            }

            // Count stages
            const stage = p.stage || 'Unknown';
            s.stages[stage] = (s.stages[stage] || 0) + 1;
        });

        // Calculate averages
        Object.values(stats).forEach(s => {
            s.avgInstall = s.avgDaysToInstall.length > 0
                ? Math.round(s.avgDaysToInstall.reduce((a, b) => a + b, 0) / s.avgDaysToInstall.length)
                : null;
            s.avgInspection = s.avgDaysToInspection.length > 0
                ? Math.round(s.avgDaysToInspection.reduce((a, b) => a + b, 0) / s.avgDaysToInspection.length)
                : null;
            s.avgPTO = s.avgDaysToPTO.length > 0
                ? Math.round(s.avgDaysToPTO.reduce((a, b) => a + b, 0) / s.avgDaysToPTO.length)
                : null;
        });

        return Object.values(stats).filter(s => s.name !== 'Unknown').sort((a, b) => b.count - a.count);
    }, [projects]);

    // Total stats
    const totals = useMemo(() => {
        return {
            count: locationStats.reduce((sum, l) => sum + l.count, 0),
            value: locationStats.reduce((sum, l) => sum + l.totalValue, 0),
            overdue: locationStats.reduce((sum, l) => sum + l.overdue, 0),
            thisMonth: locationStats.reduce((sum, l) => sum + l.thisMonth, 0)
        };
    }, [locationStats]);

    // Chart
    useEffect(() => {
        if (!chartRef.current || locationStats.length === 0) return;

        if (chartInstance.current) {
            chartInstance.current.destroy();
        }

        const ctx = chartRef.current.getContext('2d');
        const labels = locationStats.map(l => l.name);

        let data, label;
        if (metric === 'count') {
            data = locationStats.map(l => l.count);
            label = 'Project Count';
        } else if (metric === 'value') {
            data = locationStats.map(l => l.totalValue / 1000);
            label = 'Pipeline Value ($k)';
        } else if (metric === 'avgPTO') {
            data = locationStats.map(l => l.avgPTO || 0);
            label = 'Avg Days to PTO';
        } else {
            data = locationStats.map(l => l.overdue);
            label = 'Overdue Projects';
        }

        chartInstance.current = new Chart(ctx, {
            type: 'bar',
            data: {
                labels,
                datasets: [{
                    label,
                    data,
                    backgroundColor: labels.map(l => locationColors[l]?.bg || '#6B7280'),
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true }
                },
                onClick: (e, elements) => {
                    if (elements.length > 0) {
                        const idx = elements[0].index;
                        setSelectedLocation(locationStats[idx].name);
                    }
                }
            }
        });

        return () => {
            if (chartInstance.current) chartInstance.current.destroy();
        };
    }, [locationStats, metric]);

    const selectedStats = selectedLocation ? locationStats.find(l => l.name === selectedLocation) : null;

    if (loading) {
        return (
            <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                <div className="text-center">
                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                    <p className="text-gray-600">Loading location data...</p>
                </div>
            </div>
        );
    }

    if (error) {
        return (
            <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                <div className="text-center bg-white rounded-xl shadow-lg p-8">
                    <div className="text-red-500 text-4xl mb-4">⚠️</div>
                    <h2 className="text-xl font-bold text-gray-900 mb-2">Failed to Load Data</h2>
                    <p className="text-gray-600 mb-4">{error}</p>
                    <button onClick={() => window.location.reload()} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Retry
                    </button>
                </div>
            </div>
        );
    }

    return (
        <div className="min-h-screen bg-gray-50">
            {/* Header */}
            <div className="bg-white border-b sticky top-0 z-20">
                <div className="max-w-7xl mx-auto px-4 py-4">
                    <div className="flex items-center justify-between">
                        <div>
                            <h1 className="text-2xl font-bold text-gray-900">Location Comparison</h1>
                            <p className="text-gray-500">Pipeline performance across PB locations</p>
                        </div>
                        <div className="text-right">
                            <div className="inline-flex items-center px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm">
                                <span className="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></span>
                                Live Data
                            </div>
                            {lastUpdated && <p className="text-xs text-gray-400 mt-1">Updated {lastUpdated}</p>}
                        </div>
                    </div>
                </div>
            </div>

            <div className="max-w-7xl mx-auto px-4 py-6">
                {/* Summary Row */}
                <div className="grid grid-cols-4 gap-4 mb-6">
                    <div className="bg-white rounded-lg p-4 shadow-sm border">
                        <div className="text-3xl font-bold text-gray-900">{totals.count}</div>
                        <div className="text-sm text-gray-500">Total Projects</div>
                    </div>
                    <div className="bg-white rounded-lg p-4 shadow-sm border">
                        <div className="text-3xl font-bold text-green-600">${(totals.value / 1000000).toFixed(1)}M</div>
                        <div className="text-sm text-gray-500">Pipeline Value</div>
                    </div>
                    <div className="bg-white rounded-lg p-4 shadow-sm border">
                        <div className="text-3xl font-bold text-red-600">{totals.overdue}</div>
                        <div className="text-sm text-gray-500">Overdue</div>
                    </div>
                    <div className="bg-white rounded-lg p-4 shadow-sm border">
                        <div className="text-3xl font-bold text-blue-600">{totals.thisMonth}</div>
                        <div className="text-sm text-gray-500">PTO This Month</div>
                    </div>
                </div>

                {/* Chart Section */}
                <div className="bg-white rounded-lg shadow-sm border p-4 mb-6">
                    <div className="flex items-center justify-between mb-4">
                        <h2 className="text-lg font-semibold">Location Comparison</h2>
                        <div className="flex gap-2">
                            {['count', 'value', 'avgPTO', 'overdue'].map(m => (
                                <button key={m} onClick={() => setMetric(m)}
                                    className={'px-3 py-1 rounded text-sm ' + (metric === m ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200')}>
                                    {m === 'count' ? 'Count' : m === 'value' ? 'Value' : m === 'avgPTO' ? 'Avg PTO' : 'Overdue'}
                                </button>
                            ))}
                        </div>
                    </div>
                    <div className="h-64">
                        <canvas ref={chartRef}></canvas>
                    </div>
                    <div className="text-center text-xs text-gray-400 mt-2">Click a bar to see location details</div>
                </div>

                {/* Location Cards */}
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                    {locationStats.map(loc => (
                        <div key={loc.name}
                            onClick={() => setSelectedLocation(selectedLocation === loc.name ? null : loc.name)}
                            className={'rounded-lg border-2 p-4 cursor-pointer transition-all ' +
                                (selectedLocation === loc.name
                                    ? 'border-blue-500 shadow-lg'
                                    : 'border-transparent bg-white shadow-sm hover:shadow-md')
                            }
                            style={{ borderLeftColor: locationColors[loc.name]?.bg || '#6B7280', borderLeftWidth: '4px' }}>
                            <div className="flex items-center justify-between mb-3">
                                <h3 className="font-semibold text-lg">{loc.name}</h3>
                                <span className="text-2xl font-bold" style={{ color: locationColors[loc.name]?.bg || '#6B7280' }}>{loc.count}</span>
                            </div>
                            <div className="grid grid-cols-2 gap-2 text-sm">
                                <div>
                                    <div className="text-gray-500">Pipeline Value</div>
                                    <div className="font-medium">${(loc.totalValue / 1000).toFixed(0)}k</div>
                                </div>
                                <div>
                                    <div className="text-gray-500">Overdue</div>
                                    <div className={'font-medium ' + (loc.overdue > 0 ? 'text-red-600' : 'text-green-600')}>{loc.overdue}</div>
                                </div>
                                <div>
                                    <div className="text-gray-500">Avg to PTO</div>
                                    <div className="font-medium">{loc.avgPTO ? loc.avgPTO + 'd' : '-'}</div>
                                </div>
                                <div>
                                    <div className="text-gray-500">PTO This Mo</div>
                                    <div className="font-medium">{loc.thisMonth}</div>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>

                {/* Detail Panel */}
                {selectedStats && (
                    <div className="bg-white rounded-lg shadow-sm border p-6">
                        <div className="flex items-center justify-between mb-4">
                            <h2 className="text-xl font-semibold" style={{ color: locationColors[selectedStats.name]?.bg || '#6B7280' }}>
                                {selectedStats.name} Details
                            </h2>
                            <button onClick={() => setSelectedLocation(null)} className="text-gray-400 hover:text-gray-600">Close</button>
                        </div>

                        <div className="grid grid-cols-4 gap-4 mb-6">
                            <div className="bg-gray-50 rounded p-3">
                                <div className="text-2xl font-bold">{selectedStats.count}</div>
                                <div className="text-sm text-gray-500">Projects</div>
                            </div>
                            <div className="bg-gray-50 rounded p-3">
                                <div className="text-2xl font-bold text-green-600">${(selectedStats.totalValue / 1000).toFixed(0)}k</div>
                                <div className="text-sm text-gray-500">Value</div>
                            </div>
                            <div className="bg-gray-50 rounded p-3">
                                <div className="text-2xl font-bold">{selectedStats.avgInstall || '-'}d</div>
                                <div className="text-sm text-gray-500">Avg to Install</div>
                            </div>
                            <div className="bg-gray-50 rounded p-3">
                                <div className="text-2xl font-bold">{selectedStats.avgPTO || '-'}d</div>
                                <div className="text-sm text-gray-500">Avg to PTO</div>
                            </div>
                        </div>

                        <div className="mb-4">
                            <h3 className="font-medium mb-2">Stage Breakdown</h3>
                            <div className="flex flex-wrap gap-2">
                                {Object.entries(selectedStats.stages).sort((a, b) => b[1] - a[1]).map(([stage, count]) => (
                                    <span key={stage} className="px-3 py-1 bg-gray-100 rounded-full text-sm">
                                        {stage}: <strong>{count}</strong>
                                    </span>
                                ))}
                            </div>
                        </div>

                        <div>
                            <h3 className="font-medium mb-2">Projects ({selectedStats.projects.length})</h3>
                            <div className="max-h-64 overflow-y-auto">
                                <table className="w-full text-sm">
                                    <thead className="bg-gray-50 sticky top-0">
                                        <tr>
                                            <th className="text-left p-2">Project</th>
                                            <th className="text-left p-2">Stage</th>
                                            <th className="text-right p-2">Value</th>
                                            <th className="text-right p-2">Days to PTO</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {selectedStats.projects.slice(0, 20).map(p => (
                                            <tr key={p.id} className="border-t hover:bg-gray-50">
                                                <td className="p-2">
                                                    <a href={p.url} target="_blank" className="text-blue-600 hover:underline">
                                                        {p.name.split('|')[0].trim()}
                                                    </a>
                                                </td>
                                                <td className="p-2 text-gray-600">{p.stage}</td>
                                                <td className="p-2 text-right">${((p.amount || 0) / 1000).toFixed(0)}k</td>
                                                <td className="p-2 text-right">
                                                    <span className={p.days_to_pto !== null && p.days_to_pto < 0 ? 'text-red-600' : p.days_to_pto !== null && p.days_to_pto <= 30 ? 'text-yellow-600' : 'text-green-600'}>
                                                        {p.days_to_pto !== null ? p.days_to_pto + 'd' : '-'}
                                                    </span>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                                {selectedStats.projects.length > 20 && (
                                    <div className="text-center text-gray-400 text-sm py-2">
                                        Showing 20 of {selectedStats.projects.length} projects
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                )}

                <div className="mt-8 text-center text-sm text-gray-400">
                    Data synced from HubSpot • Auto-refreshes every 5 minutes
                </div>
            </div>
        </div>
    );
}

ReactDOM.render(<LocationDashboard />, document.getElementById('root'));
    </script>
</body>
</html>
