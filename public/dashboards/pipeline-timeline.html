<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="PB Pipeline Timeline - Visual project timeline with milestone forecasting">
    <meta name="theme-color" content="#0f172a">
    <title>Pipeline Timeline | Photon Brothers</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .timeline-bar { transition: all 0.2s ease; }
        .timeline-bar:hover { filter: brightness(1.1); transform: scaleY(1.2); }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
const { useState, useMemo, useEffect } = React;

function transformProject(p) {
    const now = new Date();
    const closeDate = p.closeDate ? new Date(p.closeDate) : null;
    const daysSinceClose = closeDate ? Math.floor((now - closeDate) / (1000 * 60 * 60 * 24)) : 0;

    const forecastInstall = p.installScheduleDate || (closeDate ? new Date(closeDate.getTime() + 75*24*60*60*1000).toISOString().split('T')[0] : null);
    const forecastInspection = p.inspectionCompletionDate || (closeDate ? new Date(closeDate.getTime() + 114*24*60*60*1000).toISOString().split('T')[0] : null);
    const forecastPto = p.ptoCompletionDate || (closeDate ? new Date(closeDate.getTime() + 139*24*60*60*1000).toISOString().split('T')[0] : null);

    return {
        id: p.id,
        name: p.name,
        pb_location: p.pbLocation || 'Unknown',
        stage: p.stage,
        amount: p.amount || 0,
        url: p.url,
        close_date: p.closeDate,
        forecast_install: forecastInstall,
        forecast_inspection: forecastInspection,
        forecast_pto: forecastPto,
        days_since_close: daysSinceClose
    };
}

function TimelineView() {
    const [projects, setProjects] = useState([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);
    const [lastUpdated, setLastUpdated] = useState(null);
    const [viewMode, setViewMode] = useState('month');
    const [selectedLocation, setSelectedLocation] = useState('all');
    const [milestone, setMilestone] = useState('pto');
    const [sortBy, setSortBy] = useState('date');

    const today = new Date();

    useEffect(() => {
        async function fetchData() {
            try {
                setLoading(true);
                const response = await fetch('/api/projects?context=executive');
                if (!response.ok) throw new Error('Failed to fetch data');
                const data = await response.json();
                setProjects(data.projects.map(transformProject));
                setLastUpdated(new Date().toLocaleTimeString());
                setError(null);
            } catch (err) {
                setError(err.message);
            } finally {
                setLoading(false);
            }
        }

        fetchData();
        const interval = setInterval(fetchData, 5 * 60 * 1000);
        return () => clearInterval(interval);
    }, []);

    const locations = useMemo(() => {
        const locs = [...new Set(projects.map(p => p.pb_location))].filter(l => l !== 'Unknown').sort();
        return ['all', ...locs];
    }, [projects]);

    const filteredProjects = useMemo(() => {
        let filtered = projects.filter(p => {
            if (selectedLocation !== 'all' && p.pb_location !== selectedLocation) return false;
            return true;
        });

        filtered.sort((a, b) => {
            if (sortBy === 'date') {
                const dateA = milestone === 'install' ? a.forecast_install : milestone === 'inspection' ? a.forecast_inspection : a.forecast_pto;
                const dateB = milestone === 'install' ? b.forecast_install : milestone === 'inspection' ? b.forecast_inspection : b.forecast_pto;
                if (!dateA) return 1;
                if (!dateB) return -1;
                return new Date(dateA) - new Date(dateB);
            } else if (sortBy === 'amount') {
                return (b.amount || 0) - (a.amount || 0);
            } else {
                return (a.pb_location || '').localeCompare(b.pb_location || '');
            }
        });

        return filtered.slice(0, 100);
    }, [projects, selectedLocation, milestone, sortBy]);

    const timelineRange = useMemo(() => {
        const dates = filteredProjects.map(p => {
            if (milestone === 'install') return new Date(p.forecast_install);
            if (milestone === 'inspection') return new Date(p.forecast_inspection);
            return new Date(p.forecast_pto);
        }).filter(d => !isNaN(d));

        if (dates.length === 0) return { start: today, end: new Date(today.getTime() + 90 * 24 * 60 * 60 * 1000) };

        const minDate = new Date(Math.min(...dates));
        const maxDate = new Date(Math.max(...dates));
        minDate.setDate(minDate.getDate() - 7);
        maxDate.setDate(maxDate.getDate() + 14);

        return { start: minDate, end: maxDate };
    }, [filteredProjects, milestone]);

    const timelineMarkers = useMemo(() => {
        const markers = [];
        const { start, end } = timelineRange;
        const current = new Date(start);

        while (current <= end) {
            if (viewMode === 'week') {
                markers.push({ date: new Date(current), label: current.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) });
                current.setDate(current.getDate() + 7);
            } else if (viewMode === 'month') {
                markers.push({ date: new Date(current), label: current.toLocaleDateString('en-US', { month: 'short', year: '2-digit' }) });
                current.setMonth(current.getMonth() + 1);
            } else {
                markers.push({ date: new Date(current), label: `Q${Math.floor(current.getMonth() / 3) + 1} ${current.getFullYear()}` });
                current.setMonth(current.getMonth() + 3);
            }
        }
        return markers;
    }, [timelineRange, viewMode]);

    const getDatePosition = (dateStr) => {
        if (!dateStr) return 0;
        const date = new Date(dateStr);
        const { start, end } = timelineRange;
        const totalDays = (end - start) / (24 * 60 * 60 * 1000);
        const daysFromStart = (date - start) / (24 * 60 * 60 * 1000);
        return Math.max(0, Math.min(100, (daysFromStart / totalDays) * 100));
    };

    const getLocationColor = (location) => {
        const colors = {
            'Westminster': '#3B82F6',
            'Centennial': '#10B981',
            'Colorado Springs': '#F59E0B',
            'San Luis Obispo': '#8B5CF6',
            'Camarillo': '#EC4899',
            'Unknown': '#6B7280'
        };
        return colors[location] || '#6B7280';
    };

    const getStatusColor = (project) => {
        const forecastDate = milestone === 'install' ? project.forecast_install :
                           milestone === 'inspection' ? project.forecast_inspection : project.forecast_pto;
        if (!forecastDate) return '#6B7280';

        const daysUntil = Math.ceil((new Date(forecastDate) - today) / (24 * 60 * 60 * 1000));
        if (daysUntil < 0) return '#EF4444';
        if (daysUntil <= 14) return '#F59E0B';
        return '#10B981';
    };

    const stats = useMemo(() => {
        const thisMonth = filteredProjects.filter(p => {
            const date = new Date(milestone === 'install' ? p.forecast_install : milestone === 'inspection' ? p.forecast_inspection : p.forecast_pto);
            return date.getMonth() === today.getMonth() && date.getFullYear() === today.getFullYear();
        });
        const nextMonth = filteredProjects.filter(p => {
            const date = new Date(milestone === 'install' ? p.forecast_install : milestone === 'inspection' ? p.forecast_inspection : p.forecast_pto);
            const nextMonthDate = new Date(today);
            nextMonthDate.setMonth(nextMonthDate.getMonth() + 1);
            return date.getMonth() === nextMonthDate.getMonth() && date.getFullYear() === nextMonthDate.getFullYear();
        });
        const overdue = filteredProjects.filter(p => {
            const date = new Date(milestone === 'install' ? p.forecast_install : milestone === 'inspection' ? p.forecast_inspection : p.forecast_pto);
            return date < today;
        });

        return {
            thisMonth: thisMonth.length,
            thisMonthValue: thisMonth.reduce((sum, p) => sum + (p.amount || 0), 0),
            nextMonth: nextMonth.length,
            nextMonthValue: nextMonth.reduce((sum, p) => sum + (p.amount || 0), 0),
            overdue: overdue.length
        };
    }, [filteredProjects, milestone]);

    const milestoneLabel = milestone === 'install' ? 'Installation' : milestone === 'inspection' ? 'Inspection' : 'PTO';

    if (loading) {
        return (
            <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                <div className="text-center">
                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                    <p className="text-gray-600">Loading timeline data...</p>
                </div>
            </div>
        );
    }

    if (error) {
        return (
            <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                <div className="text-center bg-white rounded-xl shadow-lg p-8">
                    <div className="text-red-500 text-4xl mb-4">⚠️</div>
                    <h2 className="text-xl font-bold text-gray-900 mb-2">Failed to Load Data</h2>
                    <p className="text-gray-600 mb-4">{error}</p>
                    <button onClick={() => window.location.reload()} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Retry
                    </button>
                </div>
            </div>
        );
    }

    return (
        <div className="min-h-screen bg-gray-50">
            {/* Header */}
            <div className="bg-white border-b sticky top-0 z-20">
                <div className="max-w-7xl mx-auto px-4 py-4">
                    <div className="flex items-center justify-between mb-4">
                        <div>
                            <h1 className="text-2xl font-bold text-gray-900">Pipeline Timeline</h1>
                            <p className="text-gray-500">Visual timeline of {milestoneLabel.toLowerCase()} forecasts</p>
                        </div>
                        <div className="text-right">
                            <div className="inline-flex items-center px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm">
                                <span className="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></span>
                                Live Data
                            </div>
                            {lastUpdated && <p className="text-xs text-gray-400 mt-1">Updated {lastUpdated}</p>}
                        </div>
                    </div>

                    {/* Controls */}
                    <div className="flex flex-wrap gap-4 items-center">
                        <div className="flex items-center gap-2">
                            <span className="text-sm text-gray-600">Milestone:</span>
                            <select value={milestone} onChange={e => setMilestone(e.target.value)} className="border rounded px-3 py-1.5 text-sm">
                                <option value="install">Installation</option>
                                <option value="inspection">Inspection</option>
                                <option value="pto">PTO</option>
                            </select>
                        </div>
                        <div className="flex items-center gap-2">
                            <span className="text-sm text-gray-600">Location:</span>
                            <select value={selectedLocation} onChange={e => setSelectedLocation(e.target.value)} className="border rounded px-3 py-1.5 text-sm">
                                {locations.map(loc => (
                                    <option key={loc} value={loc}>{loc === 'all' ? 'All Locations' : loc}</option>
                                ))}
                            </select>
                        </div>
                        <div className="flex items-center gap-2">
                            <span className="text-sm text-gray-600">View:</span>
                            <div className="flex border rounded overflow-hidden">
                                {['week', 'month', 'quarter'].map(mode => (
                                    <button key={mode} onClick={() => setViewMode(mode)}
                                        className={`px-3 py-1.5 text-sm ${viewMode === mode ? 'bg-blue-600 text-white' : 'bg-white text-gray-600 hover:bg-gray-50'}`}>
                                        {mode.charAt(0).toUpperCase() + mode.slice(1)}
                                    </button>
                                ))}
                            </div>
                        </div>
                        <div className="flex items-center gap-2">
                            <span className="text-sm text-gray-600">Sort:</span>
                            <select value={sortBy} onChange={e => setSortBy(e.target.value)} className="border rounded px-3 py-1.5 text-sm">
                                <option value="date">By Date</option>
                                <option value="amount">By Value</option>
                                <option value="location">By Location</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            {/* Stats Cards */}
            <div className="max-w-7xl mx-auto px-4 py-4">
                <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                    <div className="bg-white rounded-lg p-4 shadow-sm border">
                        <div className="text-2xl font-bold text-blue-600">{stats.thisMonth}</div>
                        <div className="text-sm text-gray-600">This Month</div>
                        <div className="text-xs text-gray-400">${(stats.thisMonthValue / 1000).toFixed(0)}k value</div>
                    </div>
                    <div className="bg-white rounded-lg p-4 shadow-sm border">
                        <div className="text-2xl font-bold text-green-600">{stats.nextMonth}</div>
                        <div className="text-sm text-gray-600">Next Month</div>
                        <div className="text-xs text-gray-400">${(stats.nextMonthValue / 1000).toFixed(0)}k value</div>
                    </div>
                    <div className="bg-white rounded-lg p-4 shadow-sm border">
                        <div className="text-2xl font-bold text-red-600">{stats.overdue}</div>
                        <div className="text-sm text-gray-600">Overdue</div>
                    </div>
                    <div className="bg-white rounded-lg p-4 shadow-sm border">
                        <div className="text-2xl font-bold text-gray-800">{filteredProjects.length}</div>
                        <div className="text-sm text-gray-600">Total Projects</div>
                    </div>
                    <div className="bg-white rounded-lg p-4 shadow-sm border">
                        <div className="text-2xl font-bold text-purple-600">
                            ${(filteredProjects.reduce((sum, p) => sum + (p.amount || 0), 0) / 1000000).toFixed(1)}M
                        </div>
                        <div className="text-sm text-gray-600">Pipeline Value</div>
                    </div>
                </div>

                {/* Legend */}
                <div className="bg-white rounded-lg p-3 shadow-sm border mb-4 flex flex-wrap gap-4 items-center">
                    <span className="text-sm font-medium text-gray-600">Locations:</span>
                    {['Westminster', 'Centennial', 'Colorado Springs', 'San Luis Obispo', 'Camarillo'].map(loc => (
                        <div key={loc} className="flex items-center gap-1">
                            <div className="w-3 h-3 rounded" style={{ backgroundColor: getLocationColor(loc) }}></div>
                            <span className="text-xs text-gray-600">{loc}</span>
                        </div>
                    ))}
                    <span className="mx-4 text-gray-300">|</span>
                    <span className="text-sm font-medium text-gray-600">Status:</span>
                    <div className="flex items-center gap-1"><div className="w-3 h-3 rounded bg-red-500"></div><span className="text-xs text-gray-600">Overdue</span></div>
                    <div className="flex items-center gap-1"><div className="w-3 h-3 rounded bg-yellow-500"></div><span className="text-xs text-gray-600">≤14 days</span></div>
                    <div className="flex items-center gap-1"><div className="w-3 h-3 rounded bg-green-500"></div><span className="text-xs text-gray-600">On track</span></div>
                </div>

                {/* Timeline */}
                <div className="bg-white rounded-lg shadow-sm border overflow-hidden">
                    {/* Timeline Header */}
                    <div className="flex border-b bg-gray-50 sticky top-[140px] z-10">
                        <div className="w-64 flex-shrink-0 px-4 py-2 font-medium text-gray-700 border-r">Project</div>
                        <div className="flex-1 relative">
                            <div className="flex">
                                {timelineMarkers.map((marker, i) => (
                                    <div key={i} className="flex-1 text-center text-xs text-gray-500 py-2 border-l first:border-l-0">
                                        {marker.label}
                                    </div>
                                ))}
                            </div>
                            <div className="absolute top-0 bottom-0 w-0.5 bg-red-500 z-10"
                                style={{ left: `${getDatePosition(today.toISOString())}%` }}>
                                <div className="absolute -top-1 left-1/2 -translate-x-1/2 bg-red-500 text-white text-xs px-1 rounded">Today</div>
                            </div>
                        </div>
                    </div>

                    {/* Timeline Rows */}
                    <div className="max-h-[600px] overflow-y-auto">
                        {filteredProjects.map((project, idx) => {
                            const forecastDate = milestone === 'install' ? project.forecast_install :
                                               milestone === 'inspection' ? project.forecast_inspection : project.forecast_pto;
                            const closePos = getDatePosition(project.close_date);
                            const forecastPos = getDatePosition(forecastDate);

                            return (
                                <div key={project.id} className={`flex border-b hover:bg-gray-50 ${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50/50'}`}>
                                    <div className="w-64 flex-shrink-0 px-4 py-2 border-r">
                                        <a href={project.url} target="_blank" className="text-sm font-medium text-blue-600 hover:underline truncate block">
                                            {project.name.split('|')[0].trim()}
                                        </a>
                                        <div className="text-xs text-gray-500 truncate">{project.pb_location} - ${(project.amount / 1000).toFixed(0)}k</div>
                                    </div>
                                    <div className="flex-1 relative py-2 px-2">
                                        <div className="absolute w-2 h-2 rounded-full bg-gray-400 top-1/2 -translate-y-1/2 z-10"
                                            style={{ left: `${closePos}%` }} title={`Closed: ${new Date(project.close_date).toLocaleDateString()}`}></div>

                                        <div className="timeline-bar absolute h-3 rounded top-1/2 -translate-y-1/2"
                                            style={{
                                                left: `${Math.min(closePos, forecastPos)}%`,
                                                width: `${Math.abs(forecastPos - closePos)}%`,
                                                backgroundColor: getLocationColor(project.pb_location),
                                                opacity: 0.7
                                            }}></div>

                                        <div className="absolute w-4 h-4 rounded-full top-1/2 -translate-y-1/2 z-10 flex items-center justify-center text-white text-xs font-bold"
                                            style={{
                                                left: `calc(${forecastPos}% - 8px)`,
                                                backgroundColor: getStatusColor(project)
                                            }}
                                            title={`${milestoneLabel}: ${forecastDate ? new Date(forecastDate).toLocaleDateString() : 'N/A'}`}>
                                            {milestone === 'install' ? 'I' : milestone === 'inspection' ? 'X' : 'P'}
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>

                <div className="text-center text-sm text-gray-500 mt-4">
                    Showing {filteredProjects.length} projects - Data synced from HubSpot - Auto-refreshes every 5 minutes
                </div>
            </div>
        </div>
    );
}

ReactDOM.render(<TimelineView />, document.getElementById('root'));
    </script>
</body>
</html>
