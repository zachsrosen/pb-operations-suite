// PB Operations Suite - Database Schema
// Using Prisma with PostgreSQL (Neon)

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ===========================================
// USER & AUTHENTICATION
// ===========================================

enum UserRole {
  ADMIN       // Full access, user management, all dashboards
  MANAGER     // Can schedule all types, view all data, manage operations
  OPERATIONS  // Can schedule installs/inspections, manage construction flow
  DESIGNER    // Design & engineering dashboard access, can update design status
  PERMITTING  // Permitting & interconnection dashboard access
  VIEWER      // Read-only access to all dashboards
  SALES       // Only survey scheduler access (for sales team)
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  image         String?
  role          UserRole  @default(VIEWER)

  // OAuth fields
  googleId      String?   @unique

  // Permissions - can override role defaults
  canScheduleSurveys      Boolean @default(false)
  canScheduleInstalls     Boolean @default(false)
  canSyncToZuper          Boolean @default(false)
  canManageUsers          Boolean @default(false)
  canManageAvailability   Boolean @default(false)

  // Location restrictions (empty = all locations)
  allowedLocations        String[] @default([])

  // Admin impersonation - when set, this admin is viewing as another user
  impersonatingUserId     String?

  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?

  // Relations
  activities    ActivityLog[]

  @@index([email])
  @@index([role])
  @@index([impersonatingUserId])
}

// ===========================================
// ACTIVITY TRACKING
// ===========================================

enum ActivityType {
  // Auth
  LOGIN
  LOGOUT
  LOGIN_FAILED
  SESSION_EXPIRED

  // Scheduling - Surveys
  SURVEY_SCHEDULED
  SURVEY_RESCHEDULED
  SURVEY_CANCELLED
  SURVEY_COMPLETED

  // Scheduling - Installations
  INSTALL_SCHEDULED
  INSTALL_RESCHEDULED
  INSTALL_CANCELLED
  INSTALL_COMPLETED

  // Scheduling - Inspections
  INSPECTION_SCHEDULED
  INSPECTION_RESCHEDULED
  INSPECTION_CANCELLED
  INSPECTION_PASSED
  INSPECTION_FAILED

  // Zuper sync
  ZUPER_JOB_CREATED
  ZUPER_JOB_UPDATED
  ZUPER_JOB_ASSIGNED
  ZUPER_ASSIGNMENT_FAILED
  ZUPER_SYNC_ERROR

  // HubSpot
  HUBSPOT_DEAL_VIEWED
  HUBSPOT_DEAL_UPDATED
  HUBSPOT_SYNC_ERROR

  // Dashboard access
  DASHBOARD_VIEWED
  DASHBOARD_FILTERED
  PROJECT_VIEWED
  PROJECT_SEARCHED

  // Data export
  REPORT_EXPORTED
  DATA_EXPORTED
  CSV_DOWNLOADED

  // User management
  USER_CREATED
  USER_UPDATED
  USER_ROLE_CHANGED
  USER_DELETED
  USER_PERMISSIONS_CHANGED
  USER_INVITED

  // System
  SETTINGS_CHANGED
  ERROR_OCCURRED
  API_ERROR
  FEATURE_USED
}

model ActivityLog {
  id          String       @id @default(cuid())
  type        ActivityType
  description String

  // Who performed the action
  userId      String?
  user        User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  userEmail   String?      // Stored separately in case user is deleted
  userName    String?      // User's display name at time of action

  // What was affected
  entityType  String?      // "project", "job", "user", "dashboard", etc.
  entityId    String?      // The ID of the affected entity
  entityName  String?      // Human-readable name for display

  // Location context
  pbLocation  String?      // Westminster, Centennial, etc.

  // Additional context (JSON) - can include:
  // - filters applied, search terms, duration on page
  // - before/after values for changes
  // - error details, stack traces
  // - Zuper job IDs, HubSpot deal IDs
  metadata    Json?

  // Request context
  ipAddress   String?
  userAgent   String?
  requestPath String?      // The URL/route accessed
  requestMethod String?    // GET, POST, PUT, DELETE
  responseStatus Int?      // HTTP status code
  durationMs  Int?         // How long the request took

  // Session tracking
  sessionId   String?      // To group actions in a session

  // Timestamp
  createdAt   DateTime     @default(now())

  @@index([userId])
  @@index([userEmail])
  @@index([type])
  @@index([entityType, entityId])
  @@index([pbLocation])
  @@index([createdAt])
  @@index([sessionId])
}

// ===========================================
// BOOKED SLOTS (Persistent storage)
// ===========================================

model BookedSlot {
  id          String   @id @default(cuid())

  // Time slot info
  date        String   // YYYY-MM-DD
  startTime   String   // HH:mm
  endTime     String   // HH:mm

  // Assignment
  userName    String
  location    String

  // Project reference
  projectId   String   // HubSpot deal ID
  projectName String

  // Zuper reference (if synced)
  zuperJobUid String?

  // Source of booking
  source      String   @default("manual") // "manual", "zuper", "hubspot"

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([date, userName, startTime])
  @@index([date])
  @@index([projectId])
  @@index([zuperJobUid])
}

// ===========================================
// APP SETTINGS
// ===========================================

model AppSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  updatedAt DateTime @updatedAt
  updatedBy String?  // User ID who last updated

  @@index([key])
}

// ===========================================
// ZUPER JOB CACHE
// ===========================================

model ZuperJobCache {
  id              String   @id @default(cuid())

  // Zuper job info
  jobUid          String   @unique
  jobTitle        String
  jobCategory     String   // "Site Survey", "Construction", "Inspection"
  jobStatus       String   // "UNSCHEDULED", "SCHEDULED", "STARTED", etc.
  jobPriority     String?

  // Schedule info
  scheduledStart  DateTime?
  scheduledEnd    DateTime?

  // Assignment
  assignedUsers   Json?    // Array of { user_uid, user_name }
  assignedTeam    String?  // Team UID

  // Location
  customerAddress Json?    // { street, city, state, zip_code }

  // HubSpot link
  hubspotDealId   String?  // Extracted from job tags
  projectName     String?

  // Metadata
  jobTags         String[] @default([])
  jobNotes        String?

  // Cache management
  lastSyncedAt    DateTime @default(now())
  rawData         Json?    // Full Zuper response for debugging

  @@index([hubspotDealId])
  @@index([jobCategory])
  @@index([jobStatus])
  @@index([scheduledStart])
  @@index([lastSyncedAt])
}

// ===========================================
// HUBSPOT PROJECT CACHE
// ===========================================

model HubSpotProjectCache {
  id              String   @id @default(cuid())

  // HubSpot deal info
  dealId          String   @unique
  dealName        String
  stage           String
  amount          Float?

  // Customer info
  customerName    String?
  customerEmail   String?
  customerPhone   String?

  // Location
  address         String?
  city            String?
  state           String?
  zipCode         String?
  pbLocation      String?  // Westminster, Centennial, etc.

  // Equipment
  systemSizeKw    Float?
  moduleCount     Int?
  inverterCount   Int?
  batteryCount    Int?
  evCount         Int?

  // Key dates
  closeDate                   DateTime?
  siteSurveyScheduleDate      DateTime?
  siteSurveyCompletionDate    DateTime?
  designCompletionDate        DateTime?
  permitSubmitDate            DateTime?
  permitIssueDate             DateTime?
  interconnectionSubmitDate   DateTime?
  interconnectionApprovalDate DateTime?
  constructionScheduleDate    DateTime?
  constructionCompleteDate    DateTime?
  inspectionScheduleDate      DateTime?
  inspectionPassDate          DateTime?
  ptoSubmitDate               DateTime?
  ptoGrantedDate              DateTime?

  // Zuper link
  zuperJobUid     String?  // Cached Zuper job UID for quick lookup

  // Cache management
  lastSyncedAt    DateTime @default(now())
  rawData         Json?    // Full HubSpot response

  @@index([stage])
  @@index([pbLocation])
  @@index([lastSyncedAt])
  @@index([zuperJobUid])
}

// ===========================================
// CREW MEMBERS (Zuper User Configuration)
// ===========================================

model CrewMember {
  id              String   @id @default(cuid())

  // Display info
  name            String   @unique // "Drew Perry", "Joe Lynch", etc.
  email           String?  // Optional email for notifications

  // Zuper identifiers (encrypted at rest by Neon)
  zuperUserUid    String   // Zuper user UID
  zuperTeamUid    String?  // Zuper team UID for assignment

  // Work configuration
  role            String   @default("technician") // "surveyor", "technician", "inspector", "electrician", "roofer"
  locations       String[] @default([]) // Which PB locations they serve
  teamName        String?  // Crew team name: "Godzilla", "Mothman", "Jackalope", "Summit", etc.
  permissions     String[] @default([]) // Job capabilities: "Inspections", "MPUs", "GW3s", "Roof", etc.

  // Scheduling
  isActive        Boolean  @default(true)
  maxDailyJobs    Int      @default(4)

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  availabilities  CrewAvailability[]
  overrides       AvailabilityOverride[]

  @@index([name])
  @@index([role])
  @@index([teamName])
  @@index([isActive])
}

// ===========================================
// CREW AVAILABILITY (Weekly schedule slots)
// ===========================================

model CrewAvailability {
  id              String   @id @default(cuid())

  // Crew member link
  crewMemberId    String
  crewMember      CrewMember @relation(fields: [crewMemberId], references: [id], onDelete: Cascade)

  // Location
  location        String   // "Westminster", "DTC", "Colorado Springs", "SLO", "Camarillo"
  reportLocation  String?  // Where crew reports to (if different)

  // Job type
  jobType         String   @default("survey") // "survey", "construction", "inspection"

  // Weekly schedule
  dayOfWeek       Int      // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
  startTime       String   // HH:mm format (e.g. "08:00")
  endTime         String   // HH:mm format (e.g. "17:00")

  // Timezone
  timezone        String   @default("America/Denver")

  // Status
  isActive        Boolean  @default(true)

  // Audit
  createdBy       String?  // User ID who created
  updatedBy       String?  // User ID who last updated
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([crewMemberId, location, dayOfWeek, startTime])
  @@index([crewMemberId])
  @@index([location])
  @@index([jobType])
  @@index([dayOfWeek])
  @@index([isActive])
}

// ===========================================
// AVAILABILITY OVERRIDES (Date-specific exceptions)
// ===========================================

model AvailabilityOverride {
  id              String   @id @default(cuid())

  // Crew member link
  crewMemberId    String
  crewMember      CrewMember @relation(fields: [crewMemberId], references: [id], onDelete: Cascade)

  // Specific date this override applies to
  date            String   // YYYY-MM-DD

  // Optional link to the recurring slot being overridden (null = block ALL slots for this crew+date)
  availabilityId  String?

  // Override type
  type            String   // "blocked" | "custom"
  reason          String?  // "PTO", "Training", "Appointment", etc.

  // For "custom" type: alternative time window
  startTime       String?  // HH:mm
  endTime         String?  // HH:mm

  // Audit
  createdBy       String?
  updatedBy       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([crewMemberId, date, availabilityId])
  @@index([crewMemberId])
  @@index([date])
  @@index([crewMemberId, date])
}

// ===========================================
// RATE LIMITING
// ===========================================

model RateLimit {
  id              String   @id @default(cuid())

  // Identifier (email, IP, or composite)
  identifier      String   @unique

  // Limit tracking
  count           Int      @default(0)
  windowStart     DateTime @default(now())

  // Cleanup
  expiresAt       DateTime

  @@index([identifier])
  @@index([expiresAt])
}

// ===========================================
// SCHEDULE RECORDS (Permanent history)
// ===========================================

model ScheduleRecord {
  id              String   @id @default(cuid())

  // What was scheduled
  scheduleType    String   // "survey", "construction", "inspection"
  projectId       String   // HubSpot deal ID
  projectName     String

  // When
  scheduledDate   String   // YYYY-MM-DD
  scheduledStart  String?  // HH:mm (for time slots)
  scheduledEnd    String?  // HH:mm

  // Who
  assignedUser    String?  // User name
  assignedUserUid String?  // Zuper user UID
  assignedTeamUid String?  // Zuper team UID
  scheduledBy     String?  // User who made the schedule

  // Zuper sync status
  zuperJobUid     String?
  zuperSynced     Boolean  @default(false)
  zuperAssigned   Boolean  @default(false)  // Did user assignment succeed?
  zuperError      String?  // Error message if sync/assign failed

  // Status
  status          String   @default("scheduled") // "scheduled", "completed", "cancelled", "rescheduled"
  notes           String?

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([projectId])
  @@index([scheduledDate])
  @@index([scheduleType])
  @@index([status])
  @@index([zuperJobUid])
}

// ===========================================
// ROADMAP ITEMS
// ===========================================

model RoadmapItem {
  id              String   @id @default(cuid())

  // Item content
  title           String
  description     String

  // Classification
  category        String   // "performance", "features", "integrations", "ux", "analytics"
  status          String   @default("planned") // "planned", "in-progress", "under-review", "completed"

  // Voting
  votes           Int      @default(0)

  // Source
  isOfficial      Boolean  @default(false)
  submittedBy     String?

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([status])
  @@index([category])
  @@index([votes])
}
